<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K59VFCP8');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Dashboard - Enhanced Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .input-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        #urlInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        #urlInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .analysis-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .analysis-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .card-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric {
            text-align: center;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .metric-value.dev {
            color: #4CAF50;
            font-weight: bold;
        }

        .metric-value.prod {
            color: #FF9800;
            font-weight: bold;
        }

        .metric-value.sandbox {
            color: #2196F3;
            font-weight: bold;
        }

        .metric-value.production {
            color: #9C27B0;
            font-weight: bold;
        }

        .recommendations-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .panel-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .openai-btn {
            background: linear-gradient(45deg, #10a37f, #1a7f64);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .openai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 163, 127, 0.4);
        }

        .ai-buttons {
            display: flex;
            gap: 10px;
        }

        .chat-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .chat-btn:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .recommendation-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .recommendation-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .recommendation-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .recommendation-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.implement {
            background: #28a745;
            color: white;
        }

        .action-btn.implement:hover {
            background: #218838;
        }

        .action-btn.learn {
            background: #17a2b8;
            color: white;
        }

        .action-btn.learn:hover {
            background: #138496;
        }

        .recommendation-item.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recommendation-item.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        /* Proposal Cards Styles */
        .proposals-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .proposals-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .proposals-header p {
            color: #7f8c8d;
            font-size: 16px;
        }

        .proposal-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .proposal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .proposal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .proposal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .proposal-badges {
            display: flex;
            gap: 10px;
        }

        .priority-badge, .difficulty-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-badge.high {
            background-color: #e74c3c;
            color: white;
        }

        .priority-badge.medium {
            background-color: #f39c12;
            color: white;
        }

        .priority-badge.low {
            background-color: #27ae60;
            color: white;
        }

        .difficulty-badge.easy {
            background-color: #27ae60;
            color: white;
        }

        .difficulty-badge.medium {
            background-color: #f39c12;
            color: white;
        }

        .difficulty-badge.hard {
            background-color: #e74c3c;
            color: white;
        }

        .proposal-description {
            color: #34495e;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .proposal-action, .proposal-impact, .proposal-timeline {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .proposal-example {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }

        .proposal-example code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
        }

        .loading-state, .error-state {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #7f8c8d;
        }

        .loading-state {
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #bdc3c7;
        }

        .error-state {
            background-color: #fdf2f2;
            border-radius: 12px;
            border: 2px dashed #e74c3c;
            color: #e74c3c;
        }

        /* Current Issues Section */
        .current-issues-section {
            margin-bottom: 40px;
        }

        .current-issues-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .page-issue {
            margin: 5px 0;
            padding: 5px 10px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            font-size: 14px;
            color: #856404;
        }

        .proposals-loading {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #bdc3c7;
            color: #7f8c8d;
        }

        .proposals-error {
            background-color: #fdf2f2;
            border: 2px dashed #e74c3c;
            color: #e74c3c;
        }

        /* Keyword Summary Styles */
        .keyword-summary {
            margin-bottom: 20px;
        }

        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .keyword-table {
            overflow-x: auto;
        }

        .keyword-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .keyword-table th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .keyword-table td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }

        .keyword-table tr:hover {
            background-color: #f8f9fa;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #bdc3c7;
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .recommendation-status {
            display: flex;
            align-items: center;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .detailed-recommendation {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .detailed-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f3f4f6;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 16px;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        .detailed-header h3 {
            margin: 0;
            color: #1f2937;
            font-size: 24px;
        }

        .detailed-content {
            display: grid;
            gap: 24px;
        }

        .issue-section, .implementation-section, .example-section {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4f46e5;
        }

        .issue-section h4, .implementation-section h4, .example-section h4 {
            margin: 0 0 16px 0;
            color: #1f2937;
            font-size: 18px;
        }

        .issue-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .issue-item.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .issue-item.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .issue-item.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .current-value {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-family: monospace;
            font-size: 14px;
            color: #374151;
        }

        .current-stats {
            background: #e5e7eb;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .impact {
            background: #fef3c7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: #92400e;
            margin-top: 8px;
        }

        .steps-list {
            margin: 0;
            padding-left: 20px;
        }

        .steps-list li {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #374151;
        }

        .example-code {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .page-issue {
            margin: 8px 0;
            padding: 8px 12px;
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            border-radius: 4px;
            font-size: 14px;
        }

        .page-issue a {
            color: #d97706;
            text-decoration: none;
            font-weight: 500;
        }

        .page-issue a:hover {
            text-decoration: underline;
        }

        .calendar-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .calendar-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .calendar-day {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .calendar-day:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .calendar-day.has-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-content {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .content-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .social-platforms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .platform-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .platform-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .platform-content {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .social-platforms {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .context-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #0c4a6e;
        }

        .ai-chat {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .ai-messages {
            height: 300px;
            overflow-y: auto;
            padding: 16px;
            background: #f9fafb;
        }

        .ai-message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #e0f2fe;
            border-left: 4px solid #0ea5e9;
        }
        
        .ai-message p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .ai-message ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-message li {
            margin: 5px 0;
            line-height: 1.5;
        }
        
        .ai-message strong {
            color: #007bff;
            font-weight: 600;
        }
        
        .ai-message em {
            color: #6c757d;
            font-style: italic;
        }

        .user-message {
            background: #3b82f6;
            color: white;
            margin-left: auto;
            max-width: 80%;
            text-align: right;
        }

        .ai-input-container {
            display: flex;
            padding: 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .ai-input-container input {
            flex: 1;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-right: 10px;
            font-size: 14px;
        }

        .ai-input-container button {
            padding: 12px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .ai-input-container button:hover {
            background: #2563eb;
        }

        .chat-message.ai-message {
            background: white;
            border: 1px solid #e5e7eb;
            margin-right: auto;
        }

        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-input-container {
            display: flex;
            padding: 12px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .chat-input-container input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-right: 8px;
        }

        .chat-input-container button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .chat-input-container button:hover {
            background: #2563eb;
        }

        .chat-input-container button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Keyword Analysis Styles */
        .keyword-analysis-section {
            padding: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            margin: 0;
            color: #1f2937;
        }

        .add-keyword-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .add-keyword-btn:hover {
            background: #059669;
        }

        .keyword-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .keyword-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .keyword-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        .keyword-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }

        .keyword-table tr:hover {
            background: #f9fafb;
        }

        .keyword-name {
            font-weight: 600;
            color: #1f2937;
        }

        .search-volume {
            color: #6b7280;
            font-family: monospace;
        }

        .difficulty.easy {
            color: #10b981;
            font-weight: 600;
        }

        .difficulty.medium {
            color: #f59e0b;
            font-weight: 600;
        }

        .difficulty.hard {
            color: #ef4444;
            font-weight: 600;
        }

        .difficulty.unknown {
            color: #6b7280;
        }

        .current-rank {
            color: #6b7280;
        }

        .keyword-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .action-btn-small:first-child {
            background: #3b82f6;
            color: white;
        }

        .action-btn-small:first-child:hover {
            background: #2563eb;
        }

        .action-btn-small:last-child {
            background: #8b5cf6;
            color: white;
        }

        .action-btn-small:last-child:hover {
            background: #7c3aed;
        }

        .service-keywords-section {
            margin-top: 30px;
        }

        .service-keywords-section h4 {
            margin: 0 0 16px 0;
            color: #1f2937;
        }

        .service-keywords-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .service-keyword-card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .service-keyword-card h5 {
            margin: 0 0 12px 0;
            color: #374151;
            font-size: 1rem;
        }

        .service-keyword-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .service-keyword-card li {
            margin-bottom: 8px;
        }

        .keyword-suggestion {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #374151;
            transition: all 0.2s;
        }

        .keyword-suggestion:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Campaign Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .calendar-header h3 {
            margin: 0;
            color: #333;
        }

        .calendar-actions {
            display: flex;
            gap: 15px;
        }

        .campaign-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .campaign-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .campaign-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .campaign-date {
            text-align: center;
        }

        .day-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .month-day {
            font-size: 0.9rem;
            color: #666;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.scheduled {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.published {
            background: #d4edda;
            color: #155724;
        }

        .platform-campaigns {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .platform-campaign {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .platform-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .platform-icon {
            font-size: 1.2rem;
        }

        .platform-name {
            font-weight: 600;
            color: #333;
        }

        .campaign-time {
            font-size: 0.9rem;
            color: #666;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .campaign-actions {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .campaign-actions-left {
            display: flex;
            gap: 8px;
        }

        .campaign-actions-right {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .campaign-content {
            margin-bottom: 15px;
        }

        .content-text {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #333;
            margin-bottom: 8px;
        }

        .content-tip {
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .campaign-media {
            border-top: 1px solid #e9ecef;
            padding-top: 10px;
        }

        .media-upload {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .calendar-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        /* Monthly Calendar Styles */
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .btn-nav {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-nav:hover {
            background: #4338ca;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-header-row {
            display: contents;
        }

        .day-header {
            background: #f3f4f6;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .calendar-body {
            display: contents;
        }

        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .calendar-day:hover {
            background: #f9fafb;
            transform: scale(1.02);
        }

        .calendar-day.today {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .calendar-day.has-campaigns {
            background: #f0f9ff;
            border-color: #0ea5e9;
        }

        .calendar-day.empty {
            background: #f9fafb;
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
        }

        .day-number {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .campaign-indicators {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        .platform-indicator {
            font-size: 12px;
            padding: 2px 4px;
            background: rgba(79, 70, 229, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(79, 70, 229, 0.2);
        }

        /* Day Campaign View Styles */
        .day-campaign-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-back {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-back:hover {
            background: #4b5563;
        }

        .day-campaigns {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .day-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        /* Social Accounts Styles */
        .social-accounts-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .social-accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .social-account-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .social-account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #4f46e5;
        }

        .account-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .account-name {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .account-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
            display: inline-block;
        }

        .account-status.connected {
            background: #d1fae5;
            color: #065f46;
        }

        .account-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }

        .connection-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .connection-info h4 {
            color: #0369a1;
            margin-bottom: 15px;
        }

        .connection-info ul {
            list-style: none;
            padding: 0;
        }

        .connection-info li {
            padding: 5px 0;
            color: #0c4a6e;
        }

        /* Campaign Editor Modal Styles */
        .campaign-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            color: #374151;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-group textarea,
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group textarea:focus,
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .modal-footer .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-footer .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
        }

        .modal-footer .btn-secondary:hover {
            background: #4b5563;
        }

        .modal-footer .btn-primary {
            background: #4f46e5;
            color: white;
            border: none;
        }

        .modal-footer .btn-primary:hover {
            background: #4338ca;
        }

        .post-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .preview-content {
            color: #374151;
            font-size: 14px;
            line-height: 1.5;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-group label input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Approval System Styles */
        .approval-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #4f46e5;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .approval-queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .approval-stats {
            display: flex;
            gap: 8px;
        }

        .stat-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .approval-queue-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .approval-date-group {
            margin-bottom: 24px;
        }

        .date-header {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 16px;
            font-weight: 600;
        }

        .approval-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .approval-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .approval-platform {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .platform-icon {
            font-size: 20px;
        }

        .platform-name {
            font-weight: 600;
            color: #374151;
        }

        .scheduled-time {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        .approval-content {
            margin-bottom: 16px;
        }

        .content-text {
            margin: 0 0 8px 0;
            line-height: 1.5;
            color: #374151;
        }

        .content-tip {
            font-size: 14px;
            color: #6b7280;
            font-style: italic;
        }

        .approval-actions {
            display: flex;
            gap: 8px;
        }

        .approval-actions .btn {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-success {
            background: #10b981;
            color: white;
            border: none;
        }

        .btn-success:hover {
            background: #059669;
        }

        .status-badge.pending {
            background: #ffc107;
            color: #000;
        }

        .status-badge.approved {
            background: #28a745;
            color: #fff;
        }

        .status-badge.rejected {
            background: #dc3545;
            color: #fff;
        }

        .status-badge.scheduled {
            background: #17a2b8;
            color: #fff;
        }

        .status-badge.published {
            background: #6f42c1;
            color: #fff;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .approval-queue-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            margin: 0 0 8px 0;
            color: #374151;
        }

        .empty-state p {
            margin: 0 0 24px 0;
            color: #6b7280;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1002;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success {
            background: #10b981;
        }

        .toast-error {
            background: #ef4444;
        }

        .toast-info {
            background: #3b82f6;
        }

        /* Media Upload Modal Styles */
        .media-upload-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: white;
            border-bottom-color: #4CAF50;
            color: #4CAF50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .media-preview, .upload-preview {
            margin-top: 15px;
            padding: 15px;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            text-align: center;
        }

        .media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .gallery-item {
            cursor: pointer;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            border-color: #4CAF50;
            transform: translateY(-2px);
        }

        .gallery-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .gallery-item span {
            display: block;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .campaign-media {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .campaign-media-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .media-info {
            flex: 1;
        }

        .media-type {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .media-alt {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        /* Social Connections Styles */
        .social-connections-header {
            margin-bottom: 30px;
            text-align: center;
        }

        .social-connections-header h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .social-connections-header p {
            color: #666;
            font-size: 16px;
        }

        .social-platforms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .platform-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            background: white;
        }

        .platform-card.connected {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .platform-card.disconnected {
            border-color: #ffcdd2;
            background: #fff8f8;
        }

        .platform-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .platform-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .platform-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .platform-details h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 18px;
        }

        .platform-status {
            margin: 0;
            font-size: 14px;
            color: #666;
        }

        .platform-actions {
            display: flex;
            gap: 10px;
        }

        .connection-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .connection-help {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #2196F3;
        }

        .connection-help h4 {
            margin-top: 0;
            color: #1976D2;
        }

        .connection-help ol {
            margin: 15px 0 0 0;
            padding-left: 20px;
        }

        .connection-help li {
            margin-bottom: 8px;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K59VFCP8"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <div class="header">
            <h1> Mozarex SEO Analysis Dashboard</h1>
            <p>Comprehensive website analysis with Mozarex AI-powered recommendations</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="urlInput" placeholder="Enter website URL (e.g., example.com)" />
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeWebsite()">
                     Analyze Website
                </button>
            </div>
        </div>

        <div id="analysisResults" style="display: none;">
            <div class="main-content">
                <div class="sidebar">
                    <div class="analysis-card active" onclick="showRecommendations('technical', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Technical Analysis</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Score</div>
                                <div class="metric-value" id="technicalScore">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Issues</div>
                                <div class="metric-value" id="technicalIssues">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card" onclick="showRecommendations('keywords', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Keyword Analysis</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Keywords</div>
                                <div class="metric-value" id="keywordCount">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Difficulty</div>
                                <div class="metric-value" id="keywordDifficulty">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card" onclick="showRecommendations('competitors', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Competitor Analysis</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Competitors</div>
                                <div class="metric-value" id="competitorCount">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Avg Rank</div>
                                <div class="metric-value" id="competitorRank">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card" onclick="showRecommendations('backlinks', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Backlink Analysis</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Backlinks</div>
                                <div class="metric-value" id="backlinkCount">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">DA Score</div>
                                <div class="metric-value" id="domainAuthority">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card" onclick="showRecommendations('calendar', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Content Calendar</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Campaigns</div>
                                <div class="metric-value" id="activeCampaigns">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Scheduled</div>
                                <div class="metric-value" id="scheduledPosts">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="analysis-card" onclick="showRecommendations('social', this)">
                        <div class="card-header">
                            <div class="card-icon"></div>
                            <div class="card-title">Social Connections</div>
                        </div>
                        <div class="card-metrics">
                            <div class="metric">
                                <div class="metric-label">Connected</div>
                                <div class="metric-value" id="connectedAccounts">-</div>
                            </div>
                            <div class="metric">
                                <div class="metric-label">Platforms</div>
                                <div class="metric-value" id="totalPlatforms">4</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Environment Status Card -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <div class="card-icon"></div>
                        <div class="card-title">Environment Status</div>
                    </div>
                    <div class="card-metrics">
                        <div class="metric">
                            <div class="metric-label">Environment</div>
                            <div class="metric-value" id="currentEnvironment">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">DataForSEO</div>
                            <div class="metric-value" id="dataforseoEnvironment">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">AI Model</div>
                            <div class="metric-value" id="openaiModel">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Social Platforms</div>
                            <div class="metric-value" id="socialPlatformsCount">-</div>
                        </div>
                    </div>
                </div>

                <div class="recommendations-panel">
                    <div class="panel-header">
                        <div class="panel-title" id="recommendationsTitle"> Technical Analysis</div>
                        <div class="ai-buttons">
                            <button class="openai-btn" onclick="showMozarexAIProposals()">
                                 AI Proposals
                            </button>
                            <button class="openai-btn chat-btn" onclick="askMozarexAI()">
                                 Chat with AI
                            </button>
                        </div>
                    </div>
                    <div id="recommendationsContent">
                        <div class="loading">Select an analysis section to view recommendations</div>
                    </div>
                </div>

                <!-- Context-Specific Mozarex AI Modal -->
                <div id="mozarexModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle"> Ask Mozarex AI</h3>
                            <span class="close" onclick="closeMozarexModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="modalContext" class="context-info"></div>
                            <div class="ai-chat">
                                <div id="aiMessages" class="ai-messages"></div>
                                <div class="ai-input-container">
                                    <input type="text" id="aiInput" placeholder="Ask Mozarex AI about this section..." />
                                    <button onclick="sendToMozarexAI()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calendar-section">
                <div class="calendar-header">
                    <div class="calendar-title"> Content Calendar</div>
                    <div class="calendar-nav">
                        <button class="btn btn-secondary" onclick="previousMonth()"> Previous</button>
                        <button class="btn btn-secondary" onclick="nextMonth()">Next </button>
                    </div>
                </div>
                <div id="calendarContent">
                    <div class="loading">Generating content calendar...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Modal -->
    <div id="contentModal" class="content-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Content Recommendations</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        console.log(' JavaScript loaded successfully!');
        let currentAnalysis = null;
        let currentDomain = null;
        let currentContext = 'technical';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        
        // Global variable to store chat history
        let chatHistory = [];
        
        function getCurrentContext() {
            const activeCard = document.querySelector('.analysis-card.active');
            if (activeCard) {
                const cardTitle = activeCard.querySelector('.card-title').textContent;
                if (cardTitle.includes('Technical')) return 'technical';
                if (cardTitle.includes('Keyword')) return 'keywords';
                if (cardTitle.includes('Competitor')) return 'competitors';
                if (cardTitle.includes('Backlink')) return 'backlinks';
                if (cardTitle.includes('Content Calendar')) return 'calendar';
            }
            return 'technical'; // Default fallback
        }
        
        function displayChatHistory() {
            const aiMessages = document.getElementById('aiMessages');
            aiMessages.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${message.type === 'user' ? 'user-message' : ''}`;
                
                if (message.type === 'user') {
                    messageDiv.innerHTML = `<strong>You:</strong> ${message.content}`;
                } else {
                    const formattedContent = formatMarkdownToHTML(message.content);
                    messageDiv.innerHTML = `<strong>Mozarex AI:</strong> ${formattedContent}`;
                }
                
                aiMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }
        
        // Test if page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' DOM loaded successfully!');
            console.log(' Analyze button found:', document.getElementById('analyzeBtn'));
            console.log(' URL input found:', document.getElementById('urlInput'));
            
            // Check if we have a domain from localStorage (opened from regular dashboard)
            const lastDomain = localStorage.getItem('lastAnalyzedDomain');
            const analysisData = localStorage.getItem('analysisData');
            
            if (lastDomain && analysisData) {
                console.log(' Auto-loading domain from regular dashboard:', lastDomain);
                
                // Set the URL input
                const urlInput = document.getElementById('urlInput');
                if (urlInput) {
                    urlInput.value = lastDomain.startsWith('http') ? lastDomain : `https://${lastDomain}`;
                }
                
                // Parse and display the analysis data
                try {
                    const parsedData = JSON.parse(analysisData);
                    console.log(' Auto-loading analysis data:', parsedData);
                    displayAnalysis(parsedData);
                    
                    // Refresh calendar metrics on page load
                    refreshCalendarMetrics();
                    
                    // Refresh social metrics on page load
                    updateSocialMetrics();
                    
                    // Refresh environment metrics on page load
                    updateEnvironmentMetrics();
                } catch (error) {
                    console.error(' Error parsing analysis data:', error);
                }
            } else {
                // Even if no analysis data, try to refresh calendar metrics
                refreshCalendarMetrics();
                
                // Refresh social metrics on page load
                updateSocialMetrics();
                
                // Refresh environment metrics on page load
                updateEnvironmentMetrics();
            }
        });

        async function analyzeWebsite() {
            console.log(' analyzeWebsite function called - START');
            const urlInput = document.getElementById('urlInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analysisResults = document.getElementById('analysisResults');
            
            const url = urlInput.value.trim();
            if (!url) {
                alert('Please enter a website URL');
                return;
            }

            console.log(' Analyzing URL:', url);

            // Process URL
            let processedUrl = url;
            if (!processedUrl.match(/^https?:\/\//)) {
                processedUrl = 'https://' + processedUrl;
            }

            console.log(' Processed URL:', processedUrl);

            analysisResults.style.display = 'block';
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = ' Analyzing...';

            // Show immediate feedback
            document.getElementById('recommendationsContent').innerHTML = '<div class="loading"> Starting analysis...</div>';

            try {
                console.log(' Making API request...');
                const response = await fetch('/api/dataforseo/environment/analyze-website', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: processedUrl })
                });

                console.log(' Response received, status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log(' Analysis result received:', result);
                console.log(' Result success:', result.success);
                console.log(' Result analysis:', result.analysis);
                console.log(' Result data:', result.data);
                
                if (result.success) {
                    // The data is in result.data, not result.analysis
                    currentAnalysis = result.data;
                    currentDomain = processedUrl;
                    console.log('Current analysis set to:', currentAnalysis);
                    console.log('Current domain set to:', currentDomain);
                    
                    if (!currentAnalysis) {
                        throw new Error('No analysis data received from server');
                    }
                    
                    displayAnalysis(currentAnalysis);
                    await generateContentCalendar();
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('recommendationsContent').innerHTML = 
                    `<div class="error">Analysis failed: ${error.message}</div>`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = ' Analyze Website';
            }
        }

        function displayAnalysis(analysis) {
            console.log(' displayAnalysis called with:', analysis);
            console.log('Analysis type:', typeof analysis);
            console.log('Analysis keys:', Object.keys(analysis || {}));
            console.log('OnPage data:', analysis?.onPage);
            console.log('Keywords data:', analysis?.keywords);
            console.log('Competitors data:', analysis?.competitors);
            
            if (!analysis) {
                console.error(' No analysis data provided to displayAnalysis');
                return;
            }
            
            // Show immediate feedback
            document.getElementById('recommendationsContent').innerHTML = '<div class="loading"> Processing analysis data...</div>';
            
            // Update technical analysis metrics
            const technicalScore = calculateTechnicalScore(analysis);
            document.getElementById('technicalScore').textContent = technicalScore;
            document.getElementById('technicalIssues').textContent = analysis.recommendations?.length || 0;

            // Update keyword analysis metrics
            console.log('Keywords data:', analysis.keywords);
            document.getElementById('keywordCount').textContent = analysis.keywords?.keywords?.length || analysis.keywords?.totalKeywords || 0;
            document.getElementById('keywordDifficulty').textContent = 
                analysis.keywords?.keywords?.length ? Math.round(analysis.keywords.keywords.reduce((sum, k) => sum + (k.difficulty || 0), 0) / analysis.keywords.keywords.length) : '-';

            // Update competitor analysis metrics
            document.getElementById('competitorCount').textContent = analysis.competitors?.competitors?.length || 0;
            document.getElementById('competitorRank').textContent = 
                analysis.competitors?.competitors?.length ? Math.round(analysis.competitors.competitors.reduce((sum, c) => sum + (c.rank || 0), 0) / analysis.competitors.competitors.length) : '-';

            // Update backlink analysis metrics
            document.getElementById('backlinkCount').textContent = analysis.backlinks?.totalBacklinks || '-';
            document.getElementById('domainAuthority').textContent = analysis.backlinks?.domainAuthority || '-';

            // Show technical recommendations by default
            showRecommendations('technical');
        }

        function calculateTechnicalScore(analysis) {
            if (!analysis || !analysis.onPage) return 0;
            
            let score = 0;
            let checks = 0;
            
            if (analysis.onPage.title) { score += 20; checks++; }
            if (analysis.onPage.metaDescription) { score += 20; checks++; }
            if (analysis.onPage.headings?.h1 && analysis.onPage.headings.h1 > 0) { score += 20; checks++; }
            if (analysis.onPage.headings?.h2 && analysis.onPage.headings.h2 > 0) { score += 15; checks++; }
            if (analysis.onPage.content?.wordCount && analysis.onPage.content.wordCount > 300) { score += 15; checks++; }
            if (analysis.onPage.images?.total > 0 && analysis.onPage.images?.missingAlt === 0) { score += 10; checks++; }
            
            return checks > 0 ? Math.round(score / checks * 5) : 0;
        }

        function showRecommendations(type, clickedElement = null) {
            console.log(' showRecommendations called with type:', type, 'clickedElement:', clickedElement);
            console.log(' Current analysis:', currentAnalysis);
            
            // Update active card if called from click event
            if (clickedElement) {
                document.querySelectorAll('.analysis-card').forEach(card => card.classList.remove('active'));
                clickedElement.classList.add('active');
                console.log(' Updated active card');
            }

            const content = document.getElementById('recommendationsContent');
            const title = document.getElementById('recommendationsTitle');
            
            if (!currentAnalysis) {
                console.log(' No currentAnalysis available');
                content.innerHTML = '<div class="loading">No analysis data available. Please run an analysis first.</div>';
                return;
            }

            console.log(' Showing recommendations for:', type, 'with data:', currentAnalysis);

            switch (type) {
                case 'technical':
                    console.log(' Calling showTechnicalRecommendations');
                    title.textContent = ' Technical Analysis';
                    showTechnicalRecommendations();
                    break;
                case 'keywords':
                    console.log(' Calling showKeywordRecommendations');
                    title.textContent = ' Keyword Analysis';
                    showKeywordRecommendations();
                    break;
                case 'competitors':
                    console.log(' Calling showCompetitorRecommendations');
                    title.textContent = ' Competitor Analysis';
                    showCompetitorRecommendations();
                    break;
                case 'backlinks':
                    console.log(' Calling showBacklinkRecommendations');
                    title.textContent = ' Backlink Analysis';
                    showBacklinkRecommendations();
                    break;
                case 'calendar':
                    console.log(' Calling showContentCalendar');
                    title.textContent = ' Content Calendar';
                    showContentCalendar();
                    break;
                case 'social':
                    console.log(' Calling showSocialConnections');
                    title.textContent = ' Social Media Connections';
                    showSocialConnections();
                    break;
                default:
                    console.log(' Unknown type:', type);
            }
        }

        async function showTechnicalRecommendations() {
            const content = document.getElementById('recommendationsContent');
            
            // Only show the current visual indicators
            showTechnicalCurrentIssues();
        }

        function showTechnicalCurrentIssues() {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            // Analyze each technical category
            const analysis = currentAnalysis.onPage || {};
            console.log('Technical analysis data:', analysis);
            console.log('Pages data:', analysis.pages);
            
            html += '<div class="current-issues-section">';
            html += '<h3> Current Technical Issues</h3>';
            
            // Title Tags - Detailed breakdown with page-specific issues
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'title\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Title Tags</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate issues from all pages
            const pagesWithTitleIssues = analysis.pages?.filter(page => {
                return !page.title || page.title.length > 60 || page.title.length < 30;
            }) || [];
            const titleIssues = pagesWithTitleIssues.length;
            let titleStatus = titleIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + titleStatus + '">' + titleIssues + ' issues</span>';
            html += '</div></div>';
            
            if (titleIssues === 0) {
                html += '<div class="recommendation-description"> All page titles are optimized</div>';
            } else {
                html += '<div class="recommendation-description"> ' + titleIssues + ' pages have title tag issues:</div>';
                // Show specific pages with issues
                pagesWithTitleIssues.forEach(page => {
                    let issueText = '';
                    if (!page.title) issueText = 'Missing title';
                    else if (page.title.length > 60) issueText = 'Too long (' + page.title.length + ' chars)';
                    else if (page.title.length < 30) issueText = 'Too short (' + page.title.length + ' chars)';
                    
                    html += '<div class="page-issue"> ' + page.url + ': ' + issueText + '</div>';
                });
            }
            html += '</div>';

            // Meta Description - Detailed breakdown
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'meta\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Meta Description</div>';
            html += '<div class="recommendation-status">';
            
            const pagesWithMetaIssues = analysis.pages?.filter(page => {
                return !page.metaDescription || page.metaDescription.length < 120 || page.metaDescription.length > 160;
            }) || [];
            const metaIssues = pagesWithMetaIssues.length;
            let metaStatus = metaIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + metaStatus + '">' + metaIssues + ' issues</span>';
            html += '</div></div>';
            
            if (metaIssues === 0) {
                html += '<div class="recommendation-description"> All meta descriptions are optimized</div>';
            } else {
                html += '<div class="recommendation-description"> ' + metaIssues + ' pages have meta description issues:</div>';
                pagesWithMetaIssues.forEach(page => {
                    let issueText = '';
                    if (!page.metaDescription) issueText = 'Missing meta description';
                    else if (page.metaDescription.length < 120) issueText = 'Too short (' + page.metaDescription.length + ' chars)';
                    else if (page.metaDescription.length > 160) issueText = 'Too long (' + page.metaDescription.length + ' chars)';
                    
                    html += '<div class="page-issue"> ' + page.url + ': ' + issueText + '</div>';
                });
            }
            html += '</div>';

            // Image Alt Text - Detailed breakdown
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'images\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Image Alt Text</div>';
            html += '<div class="recommendation-status">';
            
            const totalMissingAlt = analysis.pages?.reduce((sum, page) => sum + (page.images?.missingAlt || 0), 0) || 0;
            let imageStatus = totalMissingAlt === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + imageStatus + '">' + totalMissingAlt + ' missing</span>';
            html += '</div></div>';
            
            if (totalMissingAlt === 0) {
                html += '<div class="recommendation-description"> All images have alt text</div>';
            } else {
                html += '<div class="recommendation-description"> ' + totalMissingAlt + ' images missing alt text:</div>';
                analysis.pages?.forEach(page => {
                    if (page.images?.missingAlt > 0) {
                        html += '<div class="page-issue"> ' + page.url + ': ' + page.images.missingAlt + ' images missing alt text</div>';
                    }
                });
            }
            html += '</div>';

            // H1 Tags - Detailed breakdown
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'headings\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> H1 Tags</div>';
            html += '<div class="recommendation-status">';
            
            const pagesWithH1Issues = analysis.pages?.filter(page => {
                return page.issues?.missingH1 || (page.headings?.h1 || 0) === 0;
            }) || [];
            const h1Issues = pagesWithH1Issues.length;
            let h1Status = h1Issues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + h1Status + '">' + h1Issues + ' missing</span>';
            html += '</div></div>';
            
            if (h1Issues === 0) {
                html += '<div class="recommendation-description"> All pages have H1 tags</div>';
            } else {
                html += '<div class="recommendation-description"> ' + h1Issues + ' pages missing H1 tags:</div>';
                pagesWithH1Issues.forEach(page => {
                    html += '<div class="page-issue"> ' + page.url + ': Missing H1 tag</div>';
                });
            }
            html += '</div>';

            html += '</div>'; // Close current-issues-section
            
            content.innerHTML = html;
        }

        async function loadTechnicalProposals() {
            const content = document.getElementById('recommendationsContent');
            
            // Add loading indicator for proposals
            content.innerHTML += '<div class="proposals-loading"> Loading AI proposals...</div>';
            
            try {
                // Get current domain
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Call AI proposal generation API
                const response = await fetch('/api/ai/generate-proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        domain: domain,
                        section: 'technical'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.proposals) {
                    // Remove loading indicator
                    const loadingEl = document.querySelector('.proposals-loading');
                    if (loadingEl) loadingEl.remove();
                    
                    // Add proposals section
                    displayProposals(result.proposals, 'Technical SEO Proposals');
                } else {
                    throw new Error(result.error || 'Failed to generate proposals');
                }
                
            } catch (error) {
                console.error('Error generating technical proposals:', error);
                const loadingEl = document.querySelector('.proposals-loading');
                if (loadingEl) {
                    loadingEl.innerHTML = ' Failed to load AI proposals';
                    loadingEl.className = 'proposals-error';
                }
            }
        }

        function displayProposals(proposals, sectionTitle) {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            html += `<div class="proposals-header">
                <h3> ${sectionTitle} Proposals</h3>
                <p>AI-generated recommendations based on your website analysis</p>
            </div>`;
            
            proposals.forEach((proposal, index) => {
                const priorityClass = proposal.priority.toLowerCase();
                const difficultyClass = proposal.difficulty.toLowerCase();
                
                html += `
                <div class="proposal-card">
                    <div class="proposal-header">
                        <div class="proposal-title">${proposal.title}</div>
                        <div class="proposal-badges">
                            <span class="priority-badge ${priorityClass}">${proposal.priority}</span>
                            <span class="difficulty-badge ${difficultyClass}">${proposal.difficulty}</span>
                        </div>
                    </div>
                    <div class="proposal-description">${proposal.description}</div>
                    <div class="proposal-action">
                        <strong>Action:</strong> ${proposal.action}
                    </div>
                    <div class="proposal-impact">
                        <strong>Expected Impact:</strong> ${proposal.impact}
                    </div>
                    ${proposal.example ? `
                    <div class="proposal-example">
                        <strong>Example:</strong> 
                        <code>${proposal.example}</code>
                    </div>
                    ` : ''}
                    <div class="proposal-timeline">
                        <strong>Timeline:</strong> ${proposal.timeline}
                    </div>
                </div>
                `;
            });
            
            content.innerHTML = html;
        }

        function showTechnicalRecommendationsOld() {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            // Analyze each technical category
            const analysis = currentAnalysis.onPage || {};
            console.log('Technical analysis data:', analysis);
            console.log('Images data:', analysis.images);
            
            // Title Tags - Detailed breakdown with page-specific issues
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'title\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Title Tags</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate issues from all pages
            const pagesWithTitleIssues = analysis.onPage?.pages?.filter(page => {
                return !page.title || page.title.length > 60 || page.title.length < 30;
            }) || [];
            const titleIssues = pagesWithTitleIssues.length;
            let titleStatus = titleIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + titleStatus + '">' + titleIssues + ' issues</span>';
            html += '</div></div>';
            
            if (titleIssues === 0) {
                html += '<div class="recommendation-description"> All page titles are optimized</div>';
            } else {
                html += '<div class="recommendation-description"> ' + titleIssues + ' pages have title tag issues:</div>';
                // Show specific pages with issues
                pagesWithTitleIssues.forEach(page => {
                    let issueText = '';
                    if (!page.title) {
                        issueText = 'Missing title tag';
                    } else if (page.title.length > 60) {
                        issueText = 'Too long (' + page.title.length + ' chars)';
                    } else if (page.title.length < 30) {
                        issueText = 'Too short (' + page.title.length + ' chars)';
                    }
                    html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                });
            }
            html += '<div class="recommendation-actions">';
            html += '<button class="action-btn implement" onclick="event.stopPropagation(); implementRecommendation(\'title\')">Implement</button>';
            html += '<button class="action-btn learn" onclick="event.stopPropagation(); learnMore(\'title\')">Learn More</button>';
            html += '</div></div>';

            // Meta Description - Detailed breakdown with page-specific issues
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'meta\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Meta Description</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate meta description issues from all pages
            const pagesWithMetaIssues = analysis.pages?.filter(page => {
                return !page.metaDescription || page.metaDescription.length > 160 || page.metaDescription.length < 120;
            }) || [];
            const metaIssues = pagesWithMetaIssues.length;
            let metaStatus = metaIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + metaStatus + '">' + metaIssues + ' issues</span>';
            html += '</div></div>';
            
            if (metaIssues === 0) {
                html += '<div class="recommendation-description"> All page meta descriptions are optimized</div>';
            } else {
                html += '<div class="recommendation-description"> ' + metaIssues + ' pages have meta description issues:</div>';
                // Show specific pages with issues
                pagesWithMetaIssues.forEach(page => {
                    let issueText = '';
                    if (!page.metaDescription) {
                        issueText = 'Missing meta description';
                    } else if (page.metaDescription.length > 160) {
                        issueText = 'Too long (' + page.metaDescription.length + ' chars)';
                    } else if (page.metaDescription.length < 120) {
                        issueText = 'Too short (' + page.metaDescription.length + ' chars)';
                    }
                    html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                });
            }
            html += '<div class="recommendation-actions">';
            html += '<button class="action-btn implement" onclick="event.stopPropagation(); implementRecommendation(\'meta\')">Implement</button>';
            html += '<button class="action-btn learn" onclick="event.stopPropagation(); learnMore(\'meta\')">Learn More</button>';
            html += '</div></div>';

            // Image Alt Text - Detailed breakdown
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'images\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Image Alt Text</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate image issues from all pages
            const pagesWithImageIssues = analysis.pages?.filter(page => page.images?.missingAlt > 0) || [];
            const totalImagesWithoutAlt = pagesWithImageIssues.reduce((sum, page) => sum + (page.images?.missingAlt || 0), 0);
            const totalImages = analysis.pages?.reduce((sum, page) => sum + (page.images?.total || 0), 0) || 0;
            const imageIssues = pagesWithImageIssues.length;
            let imageStatus = imageIssues === 0 ? 'success' : 'warning';
            
            console.log('Image Alt Text Debug:');
            console.log('- analysis.pages:', analysis.pages);
            console.log('- pagesWithImageIssues:', pagesWithImageIssues);
            console.log('- totalImagesWithoutAlt:', totalImagesWithoutAlt);
            console.log('- totalImages:', totalImages);
            console.log('- imageIssues:', imageIssues);
            console.log('- imageStatus:', imageStatus);
            
            html += '<span class="status-badge ' + imageStatus + '">' + imageIssues + ' issues</span>';
            html += '</div></div>';
            
            if (imageIssues === 0) {
                html += '<div class="recommendation-description"> All images have alt text (' + totalImages + ' images)</div>';
            } else {
                html += '<div class="recommendation-description"> ' + imageIssues + ' pages have images missing alt text (' + totalImagesWithoutAlt + ' images total):</div>';
                // Show specific pages with issues
                pagesWithImageIssues.forEach(page => {
                    html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + page.images.missingAlt + ' images missing alt text</div>';
                });
            }
            html += '<div class="recommendation-actions">';
            html += '<button class="action-btn implement" onclick="event.stopPropagation(); implementRecommendation(\'alt\')">Implement</button>';
            html += '<button class="action-btn learn" onclick="event.stopPropagation(); learnMore(\'alt\')">Learn More</button>';
            html += '</div></div>';

            // Heading Structure - Detailed breakdown with page-specific issues
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'headings\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Heading Structure</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate heading issues from all pages
            const pagesWithHeadingIssues = analysis.pages?.filter(page => {
                const h1Count = page.headings?.h1 || 0;
                const h2Count = page.headings?.h2 || 0;
                return h1Count === 0 || h1Count > 1 || h2Count === 0;
            }) || [];
            const headingIssues = pagesWithHeadingIssues.length;
            let headingStatus = headingIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + headingStatus + '">' + headingIssues + ' issues</span>';
            html += '</div></div>';
            
            if (headingIssues === 0) {
                html += '<div class="recommendation-description"> All pages have proper heading structure</div>';
            } else {
                html += '<div class="recommendation-description"> ' + headingIssues + ' pages have heading structure issues:</div>';
                // Show specific pages with issues
                pagesWithHeadingIssues.forEach(page => {
                    const h1Count = page.headings?.h1 || 0;
                    const h2Count = page.headings?.h2 || 0;
                    let issueText = '';
                    
                    if (h1Count === 0) {
                        issueText = 'Missing H1 tag';
                    } else if (h1Count > 1) {
                        issueText = 'Multiple H1 tags (' + h1Count + ')';
                    }
                    if (h2Count === 0) {
                        issueText += (issueText ? ', ' : '') + 'No H2 tags';
                    }
                    
                    html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                });
            }
            html += '<div class="recommendation-actions">';
            html += '<button class="action-btn implement" onclick="event.stopPropagation(); implementRecommendation(\'heading\')">Implement</button>';
            html += '<button class="action-btn learn" onclick="event.stopPropagation(); learnMore(\'heading\')">Learn More</button>';
            html += '</div></div>';

            // Content Length - Detailed breakdown with page-specific issues
            html += '<div class="recommendation-item clickable" onclick="showDetailedRecommendation(\'content\')">';
            html += '<div class="recommendation-header">';
            html += '<div class="recommendation-title"> Content Length</div>';
            html += '<div class="recommendation-status">';
            
            // Calculate content length issues from all pages
            const pagesWithContentIssues = analysis.pages?.filter(page => {
                const wordCount = page.wordCount || 0;
                return wordCount < 300 || wordCount > 2000;
            }) || [];
            const contentIssues = pagesWithContentIssues.length;
            let contentStatus = contentIssues === 0 ? 'success' : 'warning';
            
            html += '<span class="status-badge ' + contentStatus + '">' + contentIssues + ' issues</span>';
            html += '</div></div>';
            
            if (contentIssues === 0) {
                html += '<div class="recommendation-description"> All pages have adequate content length</div>';
            } else {
                html += '<div class="recommendation-description"> ' + contentIssues + ' pages have content length issues:</div>';
                // Show specific pages with issues
                pagesWithContentIssues.forEach(page => {
                    const wordCount = page.wordCount || 0;
                    let issueText = '';
                    
                    if (wordCount < 300) {
                        issueText = 'Too short (' + wordCount + ' words)';
                    } else if (wordCount > 2000) {
                        issueText = 'Too long (' + wordCount + ' words)';
                    }
                    
                    html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                });
            }
            html += '<div class="recommendation-actions">';
            html += '<button class="action-btn implement" onclick="event.stopPropagation(); implementRecommendation(\'content\')">Implement</button>';
            html += '<button class="action-btn learn" onclick="event.stopPropagation(); learnMore(\'content\')">Learn More</button>';
            html += '</div></div>';

            content.innerHTML = html;
        }

        function showDetailedRecommendation(type) {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            const analysis = currentAnalysis.onPage || {};
            
            switch (type) {
                case 'title':
                    html += '<div class="detailed-recommendation">';
                    html += '<div class="detailed-header">';
                    html += '<button class="back-btn" onclick="showTechnicalRecommendations()"> Back</button>';
                    html += '<h3> Title Tags - Detailed Analysis</h3>';
                    html += '</div>';
                    
                    html += '<div class="detailed-content">';
                    html += '<div class="issue-section">';
                    html += '<h4>Page-Specific Issues</h4>';
                    
                    // Get pages with title issues
                    const pagesWithTitleIssues = analysis.pages?.filter(page => {
                        return !page.title || page.title.length > 60 || page.title.length < 30;
                    }) || [];
                    
                    if (pagesWithTitleIssues.length === 0) {
                        html += '<div class="issue-item success"> All page titles are optimized</div>';
                    } else {
                        html += '<div class="issue-item warning"> ' + pagesWithTitleIssues.length + ' pages have title tag issues:</div>';
                        pagesWithTitleIssues.forEach(page => {
                            let issueText = '';
                            if (!page.title) {
                                issueText = 'Missing title tag';
                            } else if (page.title.length > 60) {
                                issueText = 'Too long (' + page.title.length + ' chars)';
                            } else if (page.title.length < 30) {
                                issueText = 'Too short (' + page.title.length + ' chars)';
                            }
                            html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                            if (page.title) {
                                html += '<div class="current-value">Current: "' + page.title + '"</div>';
                            }
                        });
                    }
                    html += '</div>';
                    
                    html += '<div class="implementation-section">';
                    html += '<h4>Implementation Steps</h4>';
                    html += '<ol class="steps-list">';
                    html += '<li><strong>Add/Update Title Tag:</strong> Include your primary keyword within the first 60 characters</li>';
                    html += '<li><strong>Make it Compelling:</strong> Write a title that encourages clicks from search results</li>';
                    html += '<li><strong>Include Brand:</strong> Add your brand name at the end if space allows</li>';
                    html += '<li><strong>Test Length:</strong> Ensure title displays properly in search results (under 60 characters)</li>';
                    html += '<li><strong>Unique Titles:</strong> Make sure each page has a unique title tag</li>';
                    html += '</ol>';
                    html += '</div>';
                    
                    html += '<div class="example-section">';
                    html += '<h4>Example</h4>';
                    html += '<div class="example-code">&lt;title&gt;SEO Optimization Services - Improve Your Website Rankings&lt;/title&gt;</div>';
                    html += '</div>';
                    html += '</div></div>';
                    break;
                    
                case 'meta':
                    html += '<div class="detailed-recommendation">';
                    html += '<div class="detailed-header">';
                    html += '<button class="back-btn" onclick="showTechnicalRecommendations()"> Back</button>';
                    html += '<h3> Meta Description - Detailed Analysis</h3>';
                    html += '</div>';
                    
                    html += '<div class="detailed-content">';
                    html += '<div class="issue-section">';
                    html += '<h4>Page-Specific Issues</h4>';
                    
                    // Get pages with meta description issues
                    const pagesWithMetaIssues = analysis.pages?.filter(page => {
                        return !page.metaDescription || page.metaDescription.length > 160 || page.metaDescription.length < 120;
                    }) || [];
                    
                    if (pagesWithMetaIssues.length === 0) {
                        html += '<div class="issue-item success"> All page meta descriptions are optimized</div>';
                    } else {
                        html += '<div class="issue-item warning"> ' + pagesWithMetaIssues.length + ' pages have meta description issues:</div>';
                        pagesWithMetaIssues.forEach(page => {
                            let issueText = '';
                            if (!page.metaDescription) {
                                issueText = 'Missing meta description';
                            } else if (page.metaDescription.length > 160) {
                                issueText = 'Too long (' + page.metaDescription.length + ' chars)';
                            } else if (page.metaDescription.length < 120) {
                                issueText = 'Too short (' + page.metaDescription.length + ' chars)';
                            }
                            html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                            if (page.metaDescription) {
                                html += '<div class="current-value">Current: "' + page.metaDescription + '"</div>';
                            }
                        });
                    }
                    html += '</div>';
                    
                    html += '<div class="implementation-section">';
                    html += '<h4>Implementation Steps</h4>';
                    html += '<ol class="steps-list">';
                    html += '<li><strong>Write Compelling Copy:</strong> Create a description that encourages clicks</li>';
                    html += '<li><strong>Include Keywords:</strong> Naturally incorporate your target keywords</li>';
                    html += '<li><strong>Call to Action:</strong> End with a compelling call to action</li>';
                    html += '<li><strong>Optimal Length:</strong> Keep between 120-160 characters</li>';
                    html += '<li><strong>Unique Descriptions:</strong> Write unique descriptions for each page</li>';
                    html += '</ol>';
                    html += '</div>';
                    
                    html += '<div class="example-section">';
                    html += '<h4>Example</h4>';
                    html += '<div class="example-code">&lt;meta name="description" content="Professional SEO services to boost your website rankings. Get more organic traffic and grow your business online."&gt;</div>';
                    html += '</div>';
                    html += '</div></div>';
                    break;
                    
                case 'images':
                    html += '<div class="detailed-recommendation">';
                    html += '<div class="detailed-header">';
                    html += '<button class="back-btn" onclick="showTechnicalRecommendations()"> Back</button>';
                    html += '<h3> Image Alt Text - Detailed Analysis</h3>';
                    html += '</div>';
                    
                    html += '<div class="detailed-content">';
                    html += '<div class="issue-section">';
                    html += '<h4>Page-Specific Issues</h4>';
                    
                    // Get pages with image issues
                    const pagesWithImageIssues = analysis.pages?.filter(page => page.images?.missingAlt > 0) || [];
                    const totalImagesWithoutAlt = pagesWithImageIssues.reduce((sum, page) => sum + (page.images?.missingAlt || 0), 0);
                    const totalImages = analysis.pages?.reduce((sum, page) => sum + (page.images?.total || 0), 0) || 0;
                    
                    html += '<div class="current-stats">Total Images Across All Pages: ' + totalImages + '</div>';
                    html += '<div class="current-stats">Images Missing Alt Text: ' + totalImagesWithoutAlt + '</div>';
                    
                    if (pagesWithImageIssues.length === 0) {
                        html += '<div class="issue-item success"> All images have alt text</div>';
                    } else {
                        html += '<div class="issue-item warning"> ' + pagesWithImageIssues.length + ' pages have images missing alt text:</div>';
                        pagesWithImageIssues.forEach(page => {
                            html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + page.images.missingAlt + ' images missing alt text</div>';
                            html += '<div class="current-stats">Total images on this page: ' + page.images.total + '</div>';
                        });
                    }
                    html += '</div>';
                    
                    html += '<div class="implementation-section">';
                    html += '<h4>Implementation Steps</h4>';
                    html += '<ol class="steps-list">';
                    html += '<li><strong>Audit Images:</strong> Identify all images without alt attributes</li>';
                    html += '<li><strong>Write Descriptive Alt Text:</strong> Describe what the image shows</li>';
                    html += '<li><strong>Include Keywords:</strong> Naturally incorporate relevant keywords</li>';
                    html += '<li><strong>Keep it Concise:</strong> Alt text should be under 125 characters</li>';
                    html += '<li><strong>Decorative Images:</strong> Use empty alt="" for decorative images</li>';
                    html += '</ol>';
                    html += '</div>';
                    
                    html += '<div class="example-section">';
                    html += '<h4>Example</h4>';
                    html += '<div class="example-code">&lt;img src="seo-services.jpg" alt="Professional SEO consultant analyzing website rankings on computer"&gt;</div>';
                    html += '</div>';
                    html += '</div></div>';
                    break;
                    
                case 'headings':
                    html += '<div class="detailed-recommendation">';
                    html += '<div class="detailed-header">';
                    html += '<button class="back-btn" onclick="showTechnicalRecommendations()"> Back</button>';
                    html += '<h3> Heading Structure - Detailed Analysis</h3>';
                    html += '</div>';
                    
                    html += '<div class="detailed-content">';
                    html += '<div class="issue-section">';
                    html += '<h4>Page-Specific Issues</h4>';
                    
                    // Get pages with heading issues
                    const pagesWithHeadingIssues = analysis.pages?.filter(page => {
                        const h1Count = page.headings?.h1 || 0;
                        const h2Count = page.headings?.h2 || 0;
                        return h1Count === 0 || h1Count > 1 || h2Count === 0;
                    }) || [];
                    
                    if (pagesWithHeadingIssues.length === 0) {
                        html += '<div class="issue-item success"> All pages have proper heading structure</div>';
                    } else {
                        html += '<div class="issue-item warning"> ' + pagesWithHeadingIssues.length + ' pages have heading structure issues:</div>';
                        pagesWithHeadingIssues.forEach(page => {
                            const h1Count = page.headings?.h1 || 0;
                            const h2Count = page.headings?.h2 || 0;
                            let issueText = '';
                            
                            if (h1Count === 0) {
                                issueText = 'Missing H1 tag';
                            } else if (h1Count > 1) {
                                issueText = 'Multiple H1 tags (' + h1Count + ')';
                            }
                            if (h2Count === 0) {
                                issueText += (issueText ? ', ' : '') + 'No H2 tags';
                            }
                            
                            html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                            html += '<div class="current-stats">H1: ' + h1Count + ', H2: ' + h2Count + '</div>';
                        });
                    }
                    html += '</div>';
                    
                    html += '<div class="implementation-section">';
                    html += '<h4>Implementation Steps</h4>';
                    html += '<ol class="steps-list">';
                    html += '<li><strong>Add Single H1:</strong> Include one H1 tag with your primary keyword</li>';
                    html += '<li><strong>Structure Content:</strong> Use H2 tags for main sections</li>';
                    html += '<li><strong>Hierarchy:</strong> Follow proper heading hierarchy (H1  H2  H3)</li>';
                    html += '<li><strong>Include Keywords:</strong> Naturally incorporate keywords in headings</li>';
                    html += '<li><strong>Make it Descriptive:</strong> Write headings that describe the content below</li>';
                    html += '</ol>';
                    html += '</div>';
                    
                    html += '<div class="example-section">';
                    html += '<h4>Example</h4>';
                    html += '<div class="example-code">&lt;h1&gt;SEO Services&lt;/h1&gt;<br>&lt;h2&gt;On-Page Optimization&lt;/h2&gt;<br>&lt;h2&gt;Technical SEO&lt;/h2&gt;</div>';
                    html += '</div>';
                    html += '</div></div>';
                    break;
                    
                case 'content':
                    html += '<div class="detailed-recommendation">';
                    html += '<div class="detailed-header">';
                    html += '<button class="back-btn" onclick="showTechnicalRecommendations()"> Back</button>';
                    html += '<h3> Content Length - Detailed Analysis</h3>';
                    html += '</div>';
                    
                    html += '<div class="detailed-content">';
                    html += '<div class="issue-section">';
                    html += '<h4>Page-Specific Issues</h4>';
                    
                    // Get pages with content length issues
                    const pagesWithContentIssues = analysis.pages?.filter(page => {
                        const wordCount = page.wordCount || 0;
                        return wordCount < 300 || wordCount > 2000;
                    }) || [];
                    
                    if (pagesWithContentIssues.length === 0) {
                        html += '<div class="issue-item success"> All pages have adequate content length</div>';
                    } else {
                        html += '<div class="issue-item warning"> ' + pagesWithContentIssues.length + ' pages have content length issues:</div>';
                        pagesWithContentIssues.forEach(page => {
                            const wordCount = page.wordCount || 0;
                            let issueText = '';
                            
                            if (wordCount < 300) {
                                issueText = 'Too short (' + wordCount + ' words)';
                            } else if (wordCount > 2000) {
                                issueText = 'Too long (' + wordCount + ' words)';
                            }
                            
                            html += '<div class="page-issue"> <a href="' + page.url + '" target="_blank">' + page.url + '</a> - ' + issueText + '</div>';
                            html += '<div class="current-stats">Current word count: ' + wordCount + ' words</div>';
                        });
                    }
                    html += '</div>';
                    
                    html += '<div class="implementation-section">';
                    html += '<h4>Implementation Steps</h4>';
                    html += '<ol class="steps-list">';
                    html += '<li><strong>Add Quality Content:</strong> Write informative, valuable content</li>';
                    html += '<li><strong>Target Length:</strong> Aim for 300-2000 words depending on topic</li>';
                    html += '<li><strong>Include Keywords:</strong> Naturally incorporate target keywords</li>';
                    html += '<li><strong>Structure Content:</strong> Use headings, bullet points, and paragraphs</li>';
                    html += '<li><strong>Regular Updates:</strong> Keep content fresh and up-to-date</li>';
                    html += '</ol>';
                    html += '</div>';
                    
                    html += '<div class="example-section">';
                    html += '<h4>Best Practices</h4>';
                    html += '<div class="example-code"> Blog posts: 1000-2000 words<br> Service pages: 500-1000 words<br> Product pages: 300-800 words<br> Landing pages: 300-600 words</div>';
                    html += '</div>';
                    html += '</div></div>';
                    break;
            }
            
            content.innerHTML = html;
        }

        async function showKeywordRecommendations() {
            console.log(' showKeywordRecommendations called');
            const content = document.getElementById('recommendationsContent');
            
            // Only show current keyword data
            showKeywordCurrentData();
        }

        function showKeywordCurrentData() {
            const content = document.getElementById('recommendationsContent');
            const keywords = currentAnalysis.keywords || {};
            const keywordList = keywords.keywords || [];
            
            let html = '<div class="current-issues-section">';
            html += '<h3> Current Keyword Analysis</h3>';
            
            if (keywordList.length === 0) {
                html += '<div class="no-data">No keyword data available.</div>';
            } else {
                html += '<div class="keyword-summary">';
                html += '<div class="summary-stats">';
                html += '<div class="stat-item"><span class="stat-number">' + keywordList.length + '</span><span class="stat-label">Total Keywords</span></div>';
                
                const highVolume = keywordList.filter(k => k.searchVolume === 'High').length;
                const mediumVolume = keywordList.filter(k => k.searchVolume === 'Medium').length;
                const lowVolume = keywordList.filter(k => k.searchVolume === 'Low').length;
                
                html += '<div class="stat-item"><span class="stat-number">' + highVolume + '</span><span class="stat-label">High Volume</span></div>';
                html += '<div class="stat-item"><span class="stat-number">' + mediumVolume + '</span><span class="stat-label">Medium Volume</span></div>';
                html += '<div class="stat-item"><span class="stat-number">' + lowVolume + '</span><span class="stat-label">Low Volume</span></div>';
                html += '</div>';
                
                html += '<div class="keyword-table">';
                html += '<table>';
                html += '<thead><tr><th>Keyword</th><th>Difficulty</th><th>Competition</th><th>Volume</th><th>CPC</th></tr></thead>';
                html += '<tbody>';
                
                keywordList.forEach(keyword => {
                    const difficultyClass = keyword.difficulty < 30 ? 'easy' : keyword.difficulty < 60 ? 'medium' : 'hard';
                    html += `<tr>
                        <td>${keyword.keyword}</td>
                        <td><span class="difficulty-badge ${difficultyClass}">${keyword.difficulty}/100</span></td>
                        <td>${keyword.competition}</td>
                        <td>${keyword.searchVolume}</td>
                        <td>${keyword.cpc}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        async function loadKeywordProposals() {
            const content = document.getElementById('recommendationsContent');
            
            // Add loading indicator for proposals
            content.innerHTML += '<div class="proposals-loading"> Loading AI keyword optimization proposals...</div>';
            
            try {
                // Get current domain
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Call AI proposal generation API
                const response = await fetch('/api/ai/generate-proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        domain: domain,
                        section: 'keywords'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.proposals) {
                    // Remove loading indicator
                    const loadingEl = document.querySelector('.proposals-loading');
                    if (loadingEl) loadingEl.remove();
                    
                    // Add proposals section
                    displayProposals(result.proposals, 'Keyword Optimization Proposals');
                } else {
                    throw new Error(result.error || 'Failed to generate proposals');
                }
                
            } catch (error) {
                console.error('Error generating keyword proposals:', error);
                const loadingEl = document.querySelector('.proposals-loading');
                if (loadingEl) {
                    loadingEl.innerHTML = ' Failed to load AI proposals';
                    loadingEl.className = 'proposals-error';
                }
            }
        }

        function showKeywordRecommendationsOld() {
            console.log(' showKeywordRecommendations called');
            const content = document.getElementById('recommendationsContent');
            
            console.log(' Current analysis keywords:', currentAnalysis.keywords);
            
            if (!currentAnalysis.keywords?.keywords || currentAnalysis.keywords.keywords.length === 0) {
                console.log(' No keyword data available');
                content.innerHTML = '<div class="loading">No keyword data available</div>';
                return;
            }
            
            console.log(' Found', currentAnalysis.keywords.keywords.length, 'keywords');
            
            // Rest of the function...
            let html = '';
            html += '<div class="keyword-analysis-section">';
            html += '<div class="section-header">';
            html += '<h3> Keyword Analysis</h3>';
            html += '<button class="add-keyword-btn" onclick="showAddKeywordModal()">+ Add Primary Keyword</button>';
            html += '</div>';
            
            // Keyword Table
            html += '<div class="keyword-table-container">';
            html += '<table class="keyword-table">';
            html += '<thead>';
            html += '<tr>';
            html += '<th>Keyword</th>';
            html += '<th>Search Volume</th>';
            html += '<th>Difficulty</th>';
            html += '<th>Current Rank</th>';
            html += '<th>Optimization</th>';
            html += '<th>Actions</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';
            
            currentAnalysis.keywords.keywords.slice(0, 10).forEach((keyword, index) => {
                const difficulty = keyword.difficulty || 'N/A';
                const difficultyClass = difficulty === 'N/A' ? 'unknown' : 
                                      difficulty < 30 ? 'easy' : 
                                      difficulty < 70 ? 'medium' : 'hard';
                
                html += '<tr>';
                html += '<td class="keyword-name">' + keyword.keyword + '</td>';
                html += '<td class="search-volume">' + (keyword.searchVolume || 'N/A') + '</td>';
                html += '<td class="difficulty ' + difficultyClass + '">' + difficulty + '</td>';
                html += '<td class="current-rank">' + (keyword.currentRank || 'Not ranked') + '</td>';
                html += '<td class="optimization-status">';
                html += '<span class="status-badge warning">Needs optimization</span>';
                html += '</td>';
                html += '<td class="keyword-actions">';
                html += '<button class="action-btn-small" onclick="optimizeKeyword(' + index + ')">Optimize</button>';
                html += '<button class="action-btn-small" onclick="addToCalendar(' + index + ')">Add to Calendar</button>';
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            // Service-based keyword suggestions
            html += '<div class="service-keywords-section">';
            html += '<h4> Service-Based Keyword Suggestions</h4>';
            html += '<div class="service-keywords-grid">';
            
            const serviceKeywords = generateServiceKeywords();
            serviceKeywords.forEach(service => {
                html += '<div class="service-keyword-card">';
                html += '<h5>' + service.category + '</h5>';
                html += '<ul>';
                service.keywords.forEach(keyword => {
                    html += '<li><button class="keyword-suggestion" onclick="addKeywordSuggestion(\'' + keyword + '\')">' + keyword + '</button></li>';
                });
                html += '</ul>';
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            content.innerHTML = html;
        }

        function generateServiceKeywords() {
            const domain = currentDomain || 'your business';
            const domainName = domain.replace(/\.(com|org|net|co|uk)$/i, '').replace(/^www\./, '');
            
            return [
                {
                    category: 'Core Services',
                    keywords: [
                        domainName + ' services',
                        domainName + ' solutions',
                        'professional ' + domainName,
                        domainName + ' company'
                    ]
                },
                {
                    category: 'Local SEO',
                    keywords: [
                        domainName + ' near me',
                        'best ' + domainName + ' services',
                        domainName + ' local business',
                        domainName + ' area'
                    ]
                },
                {
                    category: 'Industry Terms',
                    keywords: [
                        domainName + ' expert',
                        domainName + ' specialist',
                        'affordable ' + domainName,
                        'quality ' + domainName + ' services'
                    ]
                }
            ];
        }

        async function showCompetitorRecommendations() {
            console.log(' showCompetitorRecommendations called');
            const content = document.getElementById('recommendationsContent');
            
            // Show loading state
            content.innerHTML = '<div class="loading-state"> Mozarex AI is analyzing your competitors and generating strategic proposals...</div>';
            
            try {
                // Get current domain
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Call AI proposal generation API
                const response = await fetch('/api/ai/generate-proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        domain: domain,
                        section: 'competitors'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.proposals) {
                    displayProposals(result.proposals, 'Competitor Strategy');
                } else {
                    throw new Error(result.error || 'Failed to generate proposals');
                }
                
            } catch (error) {
                console.error('Error generating competitor proposals:', error);
                content.innerHTML = '<div class="error-state"> Failed to generate AI proposals. Please try again.</div>';
            }
        }

        function showCompetitorRecommendationsOld() {
            console.log(' showCompetitorRecommendations called');
            const content = document.getElementById('recommendationsContent');
            
            let html = '';
            
            if (!currentAnalysis.competitors || !Array.isArray(currentAnalysis.competitors) || currentAnalysis.competitors.length === 0) {
                html = '<div class="loading"> Competitor analysis not available in sandbox mode<br><small>This feature requires DataForSEO Labs subscription for production use</small></div>';
            } else {
                html += '<div class="recommendation-item">';
                html += '<div class="recommendation-title"> Top Competitors</div>';
                html += '<div class="recommendation-description">Analyze these competitors to improve your strategy:</div>';
                
                currentAnalysis.competitors.slice(0, 5).forEach(competitor => {
                    html += '<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">';
                    html += '<strong>' + competitor.domain + '</strong> - ';
                    html += 'Rank: ' + (competitor.rank || 'N/A') + ', ';
                    html += 'Traffic: ' + (competitor.traffic || 'N/A');
                    html += '</div>';
                });
                
                html += '<div class="recommendation-actions">';
                html += '<button class="action-btn implement" onclick="implementRecommendation(\'competitors\')">Analyze Strategy</button>';
                html += '<button class="action-btn learn" onclick="learnMore(\'competitors\')">Learn More</button>';
                html += '</div></div>';
            }
            
            content.innerHTML = html;
        }

        async function showBacklinkRecommendations() {
            const content = document.getElementById('recommendationsContent');
            
            // Show loading state
            content.innerHTML = '<div class="loading-state"> Mozarex AI is analyzing your backlink profile and generating link building proposals...</div>';
            
            try {
                // Get current domain
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Call AI proposal generation API
                const response = await fetch('/api/ai/generate-proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        domain: domain,
                        section: 'backlinks'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.proposals) {
                    displayProposals(result.proposals, 'Backlink Strategy');
                } else {
                    throw new Error(result.error || 'Failed to generate proposals');
                }
                
            } catch (error) {
                console.error('Error generating backlink proposals:', error);
                content.innerHTML = '<div class="error-state"> Failed to generate AI proposals. Please try again.</div>';
            }
        }

        async function showContentCalendar() {
            const content = document.getElementById('recommendationsContent');
            
            // Show loading state
            content.innerHTML = '<div class="loading-state"> Loading your content calendar and campaigns...</div>';
            
            try {
                // Get current domain
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Try to load calendar data from Supabase first
                try {
                    const response = await fetch(`/api/supabase/calendar/${domain}`);
                    const result = await response.json();
                    
                    console.log('Calendar API response:', result);
                    
                    if (result.success && result.data && result.data.length > 0) {
                        // Convert old calendar format to new campaign format
                        const campaignData = convertCalendarToCampaigns(result.data);
                        displayCampaignCalendar(campaignData);
                        
                        // Update calendar metrics
                        updateCalendarMetrics(result.data);
                        return;
                    }
                } catch (apiError) {
                    console.log('Calendar API failed, generating new calendar:', apiError);
                }
                
                // Generate new calendar if none exists or API fails
                console.log('Generating new content calendar...');
                await generateContentCalendar();
                
            } catch (error) {
                console.error('Error loading content calendar:', error);
                content.innerHTML = '<div class="error-state"> Failed to load content calendar. Please try again.</div>';
            }
        }

        function updateCalendarMetrics(calendarData) {
            try {
                // Calculate total campaigns (all content entries)
                const totalCampaigns = calendarData.length;
                
                // Calculate scheduled posts (approved campaigns)
                const scheduledPosts = calendarData.filter(entry => entry.status === 'approved').length;
                
                // Update the metrics in the sidebar
                const activeCampaignsElement = document.getElementById('activeCampaigns');
                const scheduledPostsElement = document.getElementById('scheduledPosts');
                
                if (activeCampaignsElement) {
                    activeCampaignsElement.textContent = totalCampaigns;
                }
                
                if (scheduledPostsElement) {
                    scheduledPostsElement.textContent = scheduledPosts;
                }
                
                console.log(` Calendar metrics updated: ${totalCampaigns} campaigns, ${scheduledPosts} scheduled`);
                
            } catch (error) {
                console.error('Error updating calendar metrics:', error);
            }
        }

        async function refreshCalendarMetrics() {
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                
                // Fetch latest calendar data from Supabase
                const response = await fetch(`/api/supabase/calendar/${domain}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateCalendarMetrics(result.data);
                }
                
            } catch (error) {
                console.error('Error refreshing calendar metrics:', error);
            }
        }

        function convertCalendarToCampaigns(calendarData) {
            // Convert old calendar format to new campaign format
            const campaigns = {};
            
            calendarData.forEach(entry => {
                const date = entry.target_date;
                if (!campaigns[date]) {
                    campaigns[date] = {};
                }
                
                campaigns[date][entry.content_type] = {
                    content: entry.content_ideas,
                    time: "10:00 AM", // Default time
                    tip: "Generated from existing calendar data"
                };
            });
            
            return campaigns;
        }

        function displayCampaignCalendar(calendarData) {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            html += `
                <div class="calendar-header">
                    <h3> Content Calendar & Campaigns</h3>
                    <div class="calendar-actions">
                        <button class="btn btn-primary" onclick="generateContentCalendar()"> Generate New Calendar</button>
                        <button class="btn btn-secondary" onclick="showSocialAccounts()"> Connect Social Accounts</button>
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-navigation">
                        <button class="btn-nav" onclick="changeMonth(-1)"> Previous</button>
                        <h4 id="currentMonth">${getCurrentMonthYear()}</h4>
                        <button class="btn-nav" onclick="changeMonth(1)">Next </button>
                    </div>
                    
                    <div class="monthly-calendar" id="monthlyCalendar">
                        ${generateMonthlyCalendar(calendarData)}
                    </div>
                </div>
                
                <div class="calendar-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value">${Object.keys(calendarData).length}</div>
                            <div class="stat-label">Days Scheduled</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${Object.values(calendarData).reduce((total, platforms) => total + Object.keys(platforms).length, 0)}</div>
                            <div class="stat-label">Total Posts</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Published</div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function getPlatformIcon(platform) {
            const icons = {
                twitter: '',
                facebook: '',
                instagram: '',
                tiktok: ''
            };
            return icons[platform] || '';
        }

        function generateMonthlyCalendar(calendarData) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            let html = `
                <div class="calendar-grid">
                    <div class="calendar-header-row">
                        <div class="day-header">Sun</div>
                        <div class="day-header">Mon</div>
                        <div class="day-header">Tue</div>
                        <div class="day-header">Wed</div>
                        <div class="day-header">Thu</div>
                        <div class="day-header">Fri</div>
                        <div class="day-header">Sat</div>
                    </div>
                    <div class="calendar-body">
            `;
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const hasCampaigns = calendarData[dateString];
                const isToday = date.toDateString() === new Date().toDateString();
                
                html += `
                    <div class="calendar-day ${hasCampaigns ? 'has-campaigns' : ''} ${isToday ? 'today' : ''}" 
                         onclick="showDayCampaigns('${dateString}', ${hasCampaigns ? JSON.stringify(hasCampaigns).replace(/"/g, '&quot;') : 'null'})">
                        <div class="day-number">${day}</div>
                        ${hasCampaigns ? `
                            <div class="campaign-indicators">
                                ${Object.keys(hasCampaigns).map(platform => `<span class="platform-indicator ${platform}">${getPlatformIcon(platform)}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function showDayCampaigns(dateString, campaigns) {
            if (!campaigns) {
                alert('No campaigns scheduled for this day. Click "Generate New Calendar" to create content.');
                return;
            }
            
            const content = document.getElementById('recommendationsContent');
            const date = new Date(dateString);
            const formattedDate = date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let html = `
                <div class="day-campaign-header">
                    <button class="btn-back" onclick="showContentCalendar()"> Back to Calendar</button>
                    <h3> Campaigns for ${formattedDate}</h3>
                </div>
                
                <div class="day-campaigns">
            `;
            
            Object.entries(campaigns).forEach(([platform, campaign]) => {
                html += `
                    <div class="platform-campaign" data-platform="${platform}" data-date="${dateString}">
                        <div class="platform-header">
                            <div class="platform-info">
                                <span class="platform-icon">${getPlatformIcon(platform)}</span>
                                <span class="platform-name">${platform.charAt(0).toUpperCase() + platform.slice(1)}</span>
                                <span class="campaign-time">${campaign.time}</span>
                            </div>
                            <div class="campaign-status">
                                <span class="status-badge ${campaign.status || 'pending'}">${(campaign.status || 'pending').charAt(0).toUpperCase() + (campaign.status || 'pending').slice(1)}</span>
                            </div>
                        </div>
                        
                        <div class="campaign-content">
                            <p class="content-text">${campaign.content}</p>
                            <div class="campaign-tip content-tip">
                                <strong> Tip:</strong> ${campaign.tip}
                            </div>
                        </div>
                        
                        <div class="campaign-actions">
                            <div class="campaign-actions-left">
                                <button class="btn btn-outline" onclick="editCampaign('${dateString}', '${platform}')"> Edit</button>
                                <button class="btn btn-secondary" onclick="addMedia('${dateString}', '${platform}')"> Add Media</button>
                            </div>
                            <div class="campaign-actions-right">
                                <button class="btn btn-danger" onclick="rejectCampaign('${dateString}', '${platform}')"> Reject</button>
                                <button class="btn btn-success" onclick="approveCampaign('${dateString}', '${platform}')"> Approve</button>
                                <button class="btn btn-primary" onclick="scheduleCampaign('${dateString}', '${platform}')"> Schedule</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="day-actions">
                    <button class="btn btn-primary" onclick="scheduleAllCampaigns('${dateString}')"> Schedule All for This Day</button>
                    <button class="btn btn-secondary" onclick="duplicateDay('${dateString}')"> Duplicate to Another Day</button>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function editCampaign(dateString, platform) {
            // Get current campaign data
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (!campaignElement) {
                alert('Campaign not found');
                return;
            }
            
            const currentContent = campaignElement.querySelector('.content-text')?.textContent || '';
            const currentTip = campaignElement.querySelector('.content-tip')?.textContent?.replace(' Tip: ', '') || '';
            const currentTime = campaignElement.querySelector('.campaign-time')?.textContent || '10:00 AM';
            
            // Create modal editor
            showCampaignEditor({
                dateString: dateString,
                platform: platform,
                content: currentContent,
                tip: currentTip,
                time: currentTime
            });
        }

        function showCampaignEditor(campaignData) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'campaign-editor-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeCampaignEditor()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Edit ${campaignData.platform.charAt(0).toUpperCase() + campaignData.platform.slice(1)} Campaign</h3>
                        <button class="modal-close" onclick="closeCampaignEditor()"></button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="campaign-content">Content:</label>
                            <textarea id="campaign-content" rows="4" placeholder="Enter your ${campaignData.platform} post content...">${campaignData.content}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaign-tip">Engagement Tip:</label>
                            <textarea id="campaign-tip" rows="2" placeholder="Enter engagement tip...">${campaignData.tip}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaign-time">Posting Time:</label>
                            <select id="campaign-time">
                                <option value="9:00 AM" ${campaignData.time === '9:00 AM' ? 'selected' : ''}>9:00 AM</option>
                                <option value="10:00 AM" ${campaignData.time === '10:00 AM' ? 'selected' : ''}>10:00 AM</option>
                                <option value="11:00 AM" ${campaignData.time === '11:00 AM' ? 'selected' : ''}>11:00 AM</option>
                                <option value="12:00 PM" ${campaignData.time === '12:00 PM' ? 'selected' : ''}>12:00 PM</option>
                                <option value="1:00 PM" ${campaignData.time === '1:00 PM' ? 'selected' : ''}>1:00 PM</option>
                                <option value="2:00 PM" ${campaignData.time === '2:00 PM' ? 'selected' : ''}>2:00 PM</option>
                                <option value="3:00 PM" ${campaignData.time === '3:00 PM' ? 'selected' : ''}>3:00 PM</option>
                                <option value="4:00 PM" ${campaignData.time === '4:00 PM' ? 'selected' : ''}>4:00 PM</option>
                                <option value="5:00 PM" ${campaignData.time === '5:00 PM' ? 'selected' : ''}>5:00 PM</option>
                                <option value="6:00 PM" ${campaignData.time === '6:00 PM' ? 'selected' : ''}>6:00 PM</option>
                                <option value="7:00 PM" ${campaignData.time === '7:00 PM' ? 'selected' : ''}>7:00 PM</option>
                                <option value="8:00 PM" ${campaignData.time === '8:00 PM' ? 'selected' : ''}>8:00 PM</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaign-hashtags">Hashtags (optional):</label>
                            <input type="text" id="campaign-hashtags" placeholder="#SEO #DigitalMarketing #Mozarex" value="${extractHashtags(campaignData.content)}">
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeCampaignEditor()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveCampaignEdit('${campaignData.dateString}', '${campaignData.platform}')">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on content textarea
            setTimeout(() => {
                document.getElementById('campaign-content').focus();
            }, 100);
        }

        function closeCampaignEditor() {
            const modal = document.querySelector('.campaign-editor-modal');
            if (modal) {
                modal.remove();
            }
        }

        function saveCampaignEdit(dateString, platform) {
            const content = document.getElementById('campaign-content').value.trim();
            const tip = document.getElementById('campaign-tip').value.trim();
            const time = document.getElementById('campaign-time').value;
            const hashtags = document.getElementById('campaign-hashtags').value.trim();
            
            if (!content) {
                alert('Please enter campaign content');
                return;
            }
            
            // Add hashtags to content if provided
            const finalContent = hashtags ? `${content} ${hashtags}` : content;
            
            // Update the campaign display
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (campaignElement) {
                const contentElement = campaignElement.querySelector('.content-text');
                const tipElement = campaignElement.querySelector('.content-tip');
                const timeElement = campaignElement.querySelector('.campaign-time');
                
                if (contentElement) contentElement.textContent = finalContent;
                if (tipElement) tipElement.innerHTML = `<strong> Tip:</strong> ${tip}`;
                if (timeElement) timeElement.textContent = time;
            }
            
            // Save to localStorage (in production, this would save to database)
            const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
            const calendarKey = `calendar_${domain}`;
            let calendarData = JSON.parse(localStorage.getItem(calendarKey) || '{}');
            
            if (!calendarData[dateString]) {
                calendarData[dateString] = {};
            }
            
            calendarData[dateString][platform] = {
                content: finalContent,
                tip: tip,
                time: time
            };
            
            localStorage.setItem(calendarKey, JSON.stringify(calendarData));
            
            // Save to Supabase
            saveCampaignToSupabase(dateString, platform, {
                content: finalContent,
                tip: tip,
                time: time,
                hashtags: hashtags
            });
            
            // Close modal
            closeCampaignEditor();
            
            // Show success message
            showToast(` ${platform.charAt(0).toUpperCase() + platform.slice(1)} campaign updated successfully!`, 'success');
            
            console.log(`Campaign updated:`, {
                dateString,
                platform,
                content: finalContent,
                tip,
                time
            });
        }

        async function saveCampaignToSupabase(dateString, platform, campaignData) {
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user'; // In production, get from auth

                const response = await fetch('/api/content/update-campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        domain: domain,
                        date: dateString,
                        platform: platform,
                        content: campaignData.content,
                        engagement_tip: campaignData.tip,
                        scheduled_time: campaignData.time,
                        hashtags: campaignData.hashtags,
                        status: 'draft' // Keep as draft until approved
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(' Campaign saved to Supabase:', result.data);
                    
                    // Show success message
                    showToast(' Campaign saved successfully!', 'success');
                    
                    // Close the modal
                    closeCampaignEditor();
                    
                    // Refresh the calendar to show updated content
                    setTimeout(() => {
                        showContentCalendar();
                    }, 1000);
                    
                } else {
                    console.error(' Failed to save campaign to Supabase:', result.error);
                    showToast(' Failed to save campaign: ' + result.error, 'error');
                }

            } catch (error) {
                console.error(' Error saving campaign to Supabase:', error);
            }
        }

        function extractHashtags(content) {
            const hashtagRegex = /#\w+/g;
            const hashtags = content.match(hashtagRegex);
            return hashtags ? hashtags.join(' ') : '';
        }

        async function approveCampaign(dateString, platform) {
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user';

                console.log(` Approving campaign for ${platform} on ${dateString}`);

                // Update campaign status to approved
                const response = await fetch('/api/content/update-campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        domain: domain,
                        date: dateString,
                        platform: platform,
                        status: 'approved',
                        approved_by: 'customer',
                        approved_at: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(' Campaign approved:', result.data);
                    showToast(' Campaign approved successfully!', 'success');
                    
                    // Update the campaign status in the UI
                    updateCampaignStatus(dateString, platform, 'approved');
                    
                    // Refresh calendar metrics
                    refreshCalendarMetrics();
                    
                } else {
                    throw new Error(result.error || 'Failed to approve campaign');
                }

            } catch (error) {
                console.error(' Error approving campaign:', error);
                showToast(' Failed to approve campaign: ' + error.message, 'error');
            }
        }

        async function rejectCampaign(dateString, platform) {
            try {
                const reason = prompt('Why are you rejecting this campaign? (optional):');

                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user';

                console.log(` Rejecting campaign for ${platform} on ${dateString}`);

                // Update campaign status to rejected
                const response = await fetch('/api/content/update-campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        domain: domain,
                        date: dateString,
                        platform: platform,
                        status: 'rejected',
                        rejection_reason: reason || 'Not suitable',
                        rejected_at: new Date().toISOString()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(' Campaign rejected:', result.data);
                    showToast(' Campaign rejected', 'info');
                    
                    // Update the campaign status in the UI
                    updateCampaignStatus(dateString, platform, 'rejected');
                    
                    // Refresh calendar metrics
                    refreshCalendarMetrics();
                    
                } else {
                    throw new Error(result.error || 'Failed to reject campaign');
                }

            } catch (error) {
                console.error(' Error rejecting campaign:', error);
                showToast(' Failed to reject campaign: ' + error.message, 'error');
            }
        }

        function updateCampaignStatus(dateString, platform, status) {
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (campaignElement) {
                const statusBadge = campaignElement.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    statusBadge.className = `status-badge ${status}`;
                }
            }
        }

        function scheduleCampaign(dateString, platform) {
            // Get current campaign data
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (!campaignElement) {
                alert('Campaign not found');
                return;
            }
            
            const currentTime = campaignElement.querySelector('.campaign-time')?.textContent || '10:00 AM';
            const currentContent = campaignElement.querySelector('.content-text')?.textContent || '';
            
            // Create scheduling modal
            showSchedulingModal({
                dateString: dateString,
                platform: platform,
                currentTime: currentTime,
                content: currentContent
            });
        }

        function showSchedulingModal(scheduleData) {
            const modal = document.createElement('div');
            modal.className = 'campaign-editor-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeSchedulingModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Schedule ${scheduleData.platform.charAt(0).toUpperCase() + scheduleData.platform.slice(1)} Post</h3>
                        <button class="modal-close" onclick="closeSchedulingModal()"></button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="schedule-date">Post Date:</label>
                            <input type="date" id="schedule-date" value="${scheduleData.dateString}">
                        </div>
                        
                        <div class="form-group">
                            <label for="schedule-time">Post Time:</label>
                            <select id="schedule-time">
                                <option value="9:00 AM" ${scheduleData.currentTime === '9:00 AM' ? 'selected' : ''}>9:00 AM</option>
                                <option value="10:00 AM" ${scheduleData.currentTime === '10:00 AM' ? 'selected' : ''}>10:00 AM</option>
                                <option value="11:00 AM" ${scheduleData.currentTime === '11:00 AM' ? 'selected' : ''}>11:00 AM</option>
                                <option value="12:00 PM" ${scheduleData.currentTime === '12:00 PM' ? 'selected' : ''}>12:00 PM</option>
                                <option value="1:00 PM" ${scheduleData.currentTime === '1:00 PM' ? 'selected' : ''}>1:00 PM</option>
                                <option value="2:00 PM" ${scheduleData.currentTime === '2:00 PM' ? 'selected' : ''}>2:00 PM</option>
                                <option value="3:00 PM" ${scheduleData.currentTime === '3:00 PM' ? 'selected' : ''}>3:00 PM</option>
                                <option value="4:00 PM" ${scheduleData.currentTime === '4:00 PM' ? 'selected' : ''}>4:00 PM</option>
                                <option value="5:00 PM" ${scheduleData.currentTime === '5:00 PM' ? 'selected' : ''}>5:00 PM</option>
                                <option value="6:00 PM" ${scheduleData.currentTime === '6:00 PM' ? 'selected' : ''}>6:00 PM</option>
                                <option value="7:00 PM" ${scheduleData.currentTime === '7:00 PM' ? 'selected' : ''}>7:00 PM</option>
                                <option value="8:00 PM" ${scheduleData.currentTime === '8:00 PM' ? 'selected' : ''}>8:00 PM</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="schedule-status">Status:</label>
                            <select id="schedule-status">
                                <option value="scheduled">Scheduled</option>
                                <option value="draft">Save as Draft</option>
                                <option value="publish_now">Publish Now</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Post Preview:</label>
                            <div class="post-preview">
                                <div class="preview-content">${scheduleData.content}</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auto-post" checked>
                                Enable automatic posting to ${scheduleData.platform}
                            </label>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeSchedulingModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveCampaignSchedule('${scheduleData.dateString}', '${scheduleData.platform}')">Schedule Post</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeSchedulingModal() {
            const modal = document.querySelector('.campaign-editor-modal');
            if (modal) {
                modal.remove();
            }
        }

        function saveCampaignSchedule(dateString, platform) {
            const scheduleDate = document.getElementById('schedule-date').value;
            const scheduleTime = document.getElementById('schedule-time').value;
            const scheduleStatus = document.getElementById('schedule-status').value;
            const autoPost = document.getElementById('auto-post').checked;
            
            if (!scheduleDate) {
                alert('Please select a date');
                return;
            }
            
            // Update the campaign display
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (campaignElement) {
                const timeElement = campaignElement.querySelector('.campaign-time');
                const statusElement = campaignElement.querySelector('.status-badge');
                
                if (timeElement) timeElement.textContent = scheduleTime;
                if (statusElement) {
                    statusElement.textContent = scheduleStatus === 'scheduled' ? 'Scheduled' : 
                                               scheduleStatus === 'draft' ? 'Draft' : 'Published';
                    statusElement.className = `status-badge ${scheduleStatus}`;
                }
            }
            
            // Save to localStorage
            const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
            const scheduleKey = `schedule_${domain}`;
            let scheduleData = JSON.parse(localStorage.getItem(scheduleKey) || '{}');
            
            if (!scheduleData[dateString]) {
                scheduleData[dateString] = {};
            }
            
            scheduleData[dateString][platform] = {
                date: scheduleDate,
                time: scheduleTime,
                status: scheduleStatus,
                autoPost: autoPost,
                scheduledAt: new Date().toISOString()
            };
            
            localStorage.setItem(scheduleKey, JSON.stringify(scheduleData));
            
            // Close modal
            closeSchedulingModal();
            
            // Show success message
            const statusText = scheduleStatus === 'scheduled' ? 'scheduled' : 
                              scheduleStatus === 'draft' ? 'saved as draft' : 'published';
            alert(` ${platform.charAt(0).toUpperCase() + platform.slice(1)} post ${statusText} for ${scheduleDate} at ${scheduleTime}!`);
            
            console.log(`Campaign scheduled:`, {
                dateString,
                platform,
                scheduleDate,
                scheduleTime,
                scheduleStatus,
                autoPost
            });
        }

        function addMedia(dateString, platform) {
            // Get current campaign data
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (!campaignElement) {
                alert('Campaign not found');
                return;
            }
            
            // Create media upload modal
            showMediaUploadModal({
                dateString: dateString,
                platform: platform
            });
        }

        function showMediaUploadModal(campaignData) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'campaign-editor-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeMediaUploadModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Add Media to ${campaignData.platform.charAt(0).toUpperCase() + campaignData.platform.slice(1)} Campaign</h3>
                        <button class="modal-close" onclick="closeMediaUploadModal()"></button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="media-upload-tabs">
                            <button class="tab-button active" onclick="switchMediaTab('url')"> Image/Video URL</button>
                            <button class="tab-button" onclick="switchMediaTab('upload')"> Upload File</button>
                            <button class="tab-button" onclick="switchMediaTab('gallery')"> Media Gallery</button>
                        </div>
                        
                        <div id="url-tab" class="tab-content active">
                            <div class="form-group">
                                <label for="media-url">Media URL:</label>
                                <input type="url" id="media-url" placeholder="https://example.com/image.jpg" />
                            </div>
                            
                            <div class="form-group">
                                <label for="media-type">Media Type:</label>
                                <select id="media-type">
                                    <option value="image">Image</option>
                                    <option value="video">Video</option>
                                    <option value="gif">GIF</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="media-alt">Alt Text (for accessibility):</label>
                                <input type="text" id="media-alt" placeholder="Describe the image for screen readers" />
                            </div>
                            
                            <div class="media-preview" id="media-preview" style="display: none;">
                                <img id="preview-image" style="max-width: 200px; max-height: 200px;" />
                            </div>
                        </div>
                        
                        <div id="upload-tab" class="tab-content">
                            <div class="form-group">
                                <label for="file-upload">Choose File:</label>
                                <input type="file" id="file-upload" accept="image/*,video/*" />
                            </div>
                            
                            <div class="form-group">
                                <label for="upload-alt">Alt Text (for accessibility):</label>
                                <input type="text" id="upload-alt" placeholder="Describe the image for screen readers" />
                            </div>
                            
                            <div class="upload-preview" id="upload-preview" style="display: none;">
                                <img id="upload-preview-image" style="max-width: 200px; max-height: 200px;" />
                            </div>
                        </div>
                        
                        <div id="gallery-tab" class="tab-content">
                            <div class="form-group">
                                <label>Select from Gallery:</label>
                                <div class="media-gallery">
                                    <div class="gallery-item" onclick="selectGalleryMedia('https://via.placeholder.com/300x200/4CAF50/white?text=SEO+Tips')">
                                        <img src="https://via.placeholder.com/300x200/4CAF50/white?text=SEO+Tips" alt="SEO Tips" />
                                        <span>SEO Tips</span>
                                    </div>
                                    <div class="gallery-item" onclick="selectGalleryMedia('https://via.placeholder.com/300x200/2196F3/white?text=Digital+Marketing')">
                                        <img src="https://via.placeholder.com/300x200/2196F3/white?text=Digital+Marketing" alt="Digital Marketing" />
                                        <span>Digital Marketing</span>
                                    </div>
                                    <div class="gallery-item" onclick="selectGalleryMedia('https://via.placeholder.com/300x200/FF9800/white?text=Website+Development')">
                                        <img src="https://via.placeholder.com/300x200/FF9800/white?text=Website+Development" alt="Website Development" />
                                        <span>Website Development</span>
                                    </div>
                                    <div class="gallery-item" onclick="selectGalleryMedia('https://via.placeholder.com/300x200/9C27B0/white?text=Content+Marketing')">
                                        <img src="https://via.placeholder.com/300x200/9C27B0/white?text=Content+Marketing" alt="Content Marketing" />
                                        <span>Content Marketing</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeMediaUploadModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveMediaToCampaign('${campaignData.dateString}', '${campaignData.platform}')">Add Media</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('media-url').addEventListener('input', previewMediaFromUrl);
            document.getElementById('file-upload').addEventListener('change', previewUploadedFile);
        }

        function closeMediaUploadModal() {
            const modal = document.querySelector('.campaign-editor-modal');
            if (modal) {
                modal.remove();
            }
        }

        function switchMediaTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function previewMediaFromUrl() {
            const url = document.getElementById('media-url').value;
            const preview = document.getElementById('media-preview');
            const previewImage = document.getElementById('preview-image');
            
            if (url && (url.includes('.jpg') || url.includes('.jpeg') || url.includes('.png') || url.includes('.gif'))) {
                previewImage.src = url;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        function previewUploadedFile() {
            const file = document.getElementById('file-upload').files[0];
            const preview = document.getElementById('upload-preview');
            const previewImage = document.getElementById('upload-preview-image');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        function selectGalleryMedia(url) {
            document.getElementById('media-url').value = url;
            previewMediaFromUrl();
            switchMediaTab('url');
        }

        function saveMediaToCampaign(dateString, platform) {
            const campaignElement = document.querySelector(`[data-platform="${platform}"][data-date="${dateString}"]`);
            if (!campaignElement) {
                alert('Campaign not found');
                return;
            }
            
            let mediaUrl = '';
            let mediaAlt = '';
            
            // Get media from active tab
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab.id === 'url-tab') {
                mediaUrl = document.getElementById('media-url').value.trim();
                mediaAlt = document.getElementById('media-alt').value.trim();
            } else if (activeTab.id === 'upload-tab') {
                const file = document.getElementById('file-upload').files[0];
                if (file) {
                    // In production, this would upload to a server
                    mediaUrl = URL.createObjectURL(file);
                    mediaAlt = document.getElementById('upload-alt').value.trim();
                }
            }
            
            if (!mediaUrl) {
                alert('Please select or upload media');
                return;
            }
            
            // Add media to campaign display
            const mediaContainer = campaignElement.querySelector('.campaign-media') || createMediaContainer(campaignElement);
            mediaContainer.innerHTML = `
                <div class="campaign-media-item">
                    <img src="${mediaUrl}" alt="${mediaAlt}" style="max-width: 100px; max-height: 100px; border-radius: 8px;" />
                    <div class="media-info">
                        <div class="media-type"> Media</div>
                        ${mediaAlt ? `<div class="media-alt">${mediaAlt}</div>` : ''}
                    </div>
                </div>
            `;
            
            // Save to localStorage
            const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
            const calendarKey = `calendar_${domain}`;
            let calendarData = JSON.parse(localStorage.getItem(calendarKey) || '{}');
            
            if (!calendarData[dateString]) {
                calendarData[dateString] = {};
            }
            if (!calendarData[dateString][platform]) {
                calendarData[dateString][platform] = {};
            }
            
            calendarData[dateString][platform].media = {
                url: mediaUrl,
                alt: mediaAlt,
                type: document.getElementById('media-type')?.value || 'image'
            };
            
            localStorage.setItem(calendarKey, JSON.stringify(calendarData));
            
            // Save media to Supabase
            saveMediaToSupabase(dateString, platform, {
                url: mediaUrl,
                alt: mediaAlt,
                type: document.getElementById('media-type')?.value || 'image'
            });
            
            // Close modal
            closeMediaUploadModal();
            
            // Show success message
            showToast(' Media added to campaign!', 'success');
        }

        async function saveMediaToSupabase(dateString, platform, mediaData) {
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user'; // In production, get from auth

                const response = await fetch('/api/content/update-media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        domain: domain,
                        date: dateString,
                        platform: platform,
                        media_url: mediaData.url,
                        media_alt: mediaData.alt,
                        media_type: mediaData.type
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log(' Media saved to Supabase:', result.data);
                } else {
                    console.error(' Failed to save media to Supabase:', result.error);
                }

            } catch (error) {
                console.error(' Error saving media to Supabase:', error);
            }
        }

        function createMediaContainer(campaignElement) {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'campaign-media';
            
            // Insert after campaign-content
            const contentElement = campaignElement.querySelector('.campaign-content');
            contentElement.parentNode.insertBefore(mediaContainer, contentElement.nextSibling);
            
            return mediaContainer;
        }

        function scheduleAllCampaigns(dateString) {
            if (confirm(`Schedule all campaigns for ${dateString}?`)) {
                console.log(`Scheduling all campaigns for ${dateString}`);
                alert(`All campaigns scheduled! (This will connect to all social media APIs in production)`);
            }
        }

        function duplicateDay(dateString) {
            const newDate = prompt(`Duplicate campaigns from ${dateString} to which date? (YYYY-MM-DD):`, '');
            if (newDate) {
                console.log(`Duplicating campaigns from ${dateString} to ${newDate}`);
                alert(`Campaigns duplicated to ${newDate}! (This will be saved to database in production)`);
            }
        }

        async function showSocialConnections() {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = '<div class="loading-state"> Loading social media connections...</div>';

            try {
                const userId = 'mozarex-user'; // In production, get from auth
                
                // Fetch connected accounts
                const response = await fetch(`/api/social/accounts/${userId}`);
                const result = await response.json();

                let connectedAccounts = [];
                if (result.success) {
                    connectedAccounts = result.data || [];
                }

                displaySocialConnections(connectedAccounts);

            } catch (error) {
                console.error('Error loading social connections:', error);
                content.innerHTML = '<div class="error-state"> Failed to load social connections. Please try again.</div>';
            }
        }

        async function updateEnvironmentMetrics() {
            try {
                // Fetch environment status
                const response = await fetch('/api/environment/status');
                const result = await response.json();

                if (result.success) {
                    const env = result.environment;
                    
                    // Update environment metrics
                    const currentEnvElement = document.getElementById('currentEnvironment');
                    const dataforseoEnvElement = document.getElementById('dataforseoEnvironment');
                    const openaiModelElement = document.getElementById('openaiModel');
                    const socialPlatformsElement = document.getElementById('socialPlatformsCount');
                    
                    if (currentEnvElement) {
                        currentEnvElement.textContent = env.environment;
                        currentEnvElement.className = `metric-value ${env.isDevelopment ? 'dev' : 'prod'}`;
                    }
                    
                    if (dataforseoEnvElement) {
                        dataforseoEnvElement.textContent = env.dataforseoEnvironment;
                        dataforseoEnvElement.className = `metric-value ${env.isSandbox ? 'sandbox' : 'production'}`;
                    }
                    
                    if (openaiModelElement) {
                        openaiModelElement.textContent = env.openaiModel;
                    }
                    
                    if (socialPlatformsElement) {
                        socialPlatformsElement.textContent = `${env.configuredSocialPlatforms.length}/7`;
                    }
                    
                    console.log(` Environment metrics updated: ${env.environment} mode`);
                }
                
            } catch (error) {
                console.error('Error updating environment metrics:', error);
            }
        }

        async function updateSocialMetrics() {
            try {
                const userId = 'mozarex-user'; // In production, get from auth
                
                // Fetch connected accounts
                const response = await fetch(`/api/social/accounts/${userId}`);
                const result = await response.json();

                let connectedAccounts = [];
                if (result.success) {
                    connectedAccounts = result.data || [];
                }

                // Update the metrics in the sidebar
                const connectedAccountsElement = document.getElementById('connectedAccounts');
                
                if (connectedAccountsElement) {
                    const connectedCount = connectedAccounts.filter(acc => acc.is_connected).length;
                    connectedAccountsElement.textContent = connectedCount;
                }
                
                console.log(` Social metrics updated: ${connectedAccounts.filter(acc => acc.is_connected).length} connected`);
                
            } catch (error) {
                console.error('Error updating social metrics:', error);
            }
        }

        function displaySocialConnections(connectedAccounts) {
            const content = document.getElementById('recommendationsContent');
            
            const platforms = [
                { name: 'twitter', displayName: 'Twitter', icon: '', color: '#1DA1F2' },
                { name: 'instagram', displayName: 'Instagram', icon: '', color: '#E4405F' },
                { name: 'tiktok', displayName: 'TikTok', icon: '', color: '#000000' },
                { name: 'facebook', displayName: 'Facebook', icon: '', color: '#1877F2' }
            ];

            let html = `
                <div class="social-connections-header">
                    <h3> Social Media Connections</h3>
                    <p>Connect your social media accounts to enable automatic posting and campaign management.</p>
                </div>
                
                <div class="social-platforms">
            `;

            platforms.forEach(platform => {
                const isConnected = connectedAccounts.find(acc => acc.platform === platform.name && acc.is_connected);
                
                html += `
                    <div class="platform-card ${isConnected ? 'connected' : 'disconnected'}">
                        <div class="platform-info">
                            <div class="platform-icon" style="background-color: ${platform.color}">
                                ${platform.icon}
                            </div>
                            <div class="platform-details">
                                <h4>${platform.displayName}</h4>
                                <p class="platform-status">
                                    ${isConnected ? 
                                        ` Connected since ${new Date(isConnected.connected_at).toLocaleDateString()}` : 
                                        ' Not connected'
                                    }
                                </p>
                            </div>
                        </div>
                        
                        <div class="platform-actions">
                            ${isConnected ? 
                                `<button class="btn btn-danger" onclick="disconnectPlatform('${platform.name}')"> Disconnect</button>` :
                                `<button class="btn btn-primary" onclick="connectPlatform('${platform.name}')"> Connect</button>`
                            }
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                
                <div class="connection-summary">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-value">${connectedAccounts.filter(acc => acc.is_connected).length}</div>
                            <div class="stat-label">Connected</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${platforms.length}</div>
                            <div class="stat-label">Available</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${connectedAccounts.filter(acc => acc.is_connected).length === platforms.length ? '' : ''}</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>
                
                <div class="connection-help">
                    <h4> How to Connect:</h4>
                    <ol>
                        <li>Click "Connect" on any platform</li>
                        <li>You'll be redirected to the platform's authorization page</li>
                        <li>Grant permissions for Mozarex to post on your behalf</li>
                        <li>You'll be redirected back to the dashboard</li>
                        <li>Your campaigns will automatically post to connected platforms</li>
                    </ol>
                </div>
            `;

            content.innerHTML = html;
        }

        async function connectPlatform(platform) {
            try {
                console.log(` Connecting to ${platform}...`);
                
                const response = await fetch(`/api/social/connect/${platform}`);
                const result = await response.json();

                if (result.success) {
                    // Open OAuth URL in new window
                    window.open(result.authUrl, '_blank', 'width=600,height=600');
                    
                    // Show success message
                    showToast(` Redirecting to ${platform} authorization...`, 'info');
                    
                    // Refresh connections after a delay
                    setTimeout(() => {
                        showSocialConnections();
                        updateSocialMetrics(); // Update metrics
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to initiate connection');
                }

            } catch (error) {
                console.error(`Error connecting to ${platform}:`, error);
                showToast(` Failed to connect to ${platform}: ${error.message}`, 'error');
            }
        }

        async function disconnectPlatform(platform) {
            if (!confirm(`Are you sure you want to disconnect from ${platform}?`)) {
                return;
            }

            try {
                console.log(` Disconnecting from ${platform}...`);
                
                const response = await fetch(`/api/social/disconnect/${platform}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();

                if (result.success) {
                    showToast(` Disconnected from ${platform}`, 'success');
                    showSocialConnections(); // Refresh the view
                    updateSocialMetrics(); // Update metrics
                } else {
                    throw new Error(result.error || 'Failed to disconnect');
                }

            } catch (error) {
                console.error(`Error disconnecting from ${platform}:`, error);
                showToast(` Failed to disconnect from ${platform}: ${error.message}`, 'error');
            }
        }

        function showSocialAccounts() {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = `
                <div class="social-accounts-header">
                    <button class="btn-back" onclick="showContentCalendar()"> Back to Calendar</button>
                    <h3> Connect Social Media Accounts</h3>
                </div>
                
                <div class="social-accounts-grid">
                    <div class="social-account-card" onclick="connectAccount('twitter')">
                        <div class="account-icon"></div>
                        <div class="account-name">Twitter</div>
                        <div class="account-status disconnected">Not Connected</div>
                        <button class="btn btn-primary">Connect</button>
                    </div>
                    
                    <div class="social-account-card" onclick="connectAccount('facebook')">
                        <div class="account-icon"></div>
                        <div class="account-name">Facebook</div>
                        <div class="account-status disconnected">Not Connected</div>
                        <button class="btn btn-primary">Connect</button>
                    </div>
                    
                    <div class="social-account-card" onclick="connectAccount('instagram')">
                        <div class="account-icon"></div>
                        <div class="account-name">Instagram</div>
                        <div class="account-status disconnected">Not Connected</div>
                        <button class="btn btn-primary">Connect</button>
                    </div>
                    
                    <div class="social-account-card" onclick="connectAccount('tiktok')">
                        <div class="account-icon"></div>
                        <div class="account-name">TikTok</div>
                        <div class="account-status disconnected">Not Connected</div>
                        <button class="btn btn-primary">Connect</button>
                    </div>
                </div>
                
                <div class="connection-info">
                    <h4> How Social Media Connection Works</h4>
                    <ul>
                        <li> Secure OAuth authentication</li>
                        <li> Automatic posting to your accounts</li>
                        <li> Schedule posts in advance</li>
                        <li> Track engagement metrics</li>
                        <li> Manage multiple accounts</li>
                    </ul>
                </div>
            `;
        }

        function connectAccount(platform) {
            console.log(`Connecting ${platform} account...`);
            
            // Call the OAuth endpoint
            fetch(`/api/auth/${platform}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Redirecting to ${platform} OAuth... (This will open OAuth flow in production)`);
                        
                        // Simulate connection success for demo
                        setTimeout(() => {
                            const card = document.querySelector(`[onclick="connectAccount('${platform}')"]`);
                            if (card) {
                                card.querySelector('.account-status').textContent = 'Connected';
                                card.querySelector('.account-status').className = 'account-status connected';
                                card.querySelector('button').textContent = 'Disconnect';
                                card.querySelector('button').onclick = () => disconnectAccount(platform);
                            }
                        }, 2000);
                    } else {
                        alert(`OAuth integration for ${platform} is coming soon!`);
                    }
                })
                .catch(error => {
                    console.error(`Error connecting ${platform}:`, error);
                    alert(`Failed to connect ${platform} account. Please try again.`);
                });
        }

        function disconnectAccount(platform) {
            if (confirm(`Disconnect ${platform} account?`)) {
                fetch('/api/social-accounts/disconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ platform: platform })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const card = document.querySelector(`[onclick="connectAccount('${platform}')"]`);
                        if (card) {
                            card.querySelector('.account-status').textContent = 'Not Connected';
                            card.querySelector('.account-status').className = 'account-status disconnected';
                            card.querySelector('button').textContent = 'Connect';
                            card.querySelector('button').onclick = () => connectAccount(platform);
                        }
                        alert(`${platform} account disconnected successfully!`);
                    }
                })
                .catch(error => {
                    console.error(`Error disconnecting ${platform}:`, error);
                    alert(`Failed to disconnect ${platform} account. Please try again.`);
                });
            }
        }

        function getCurrentMonthYear() {
            const today = new Date();
            return today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        function changeMonth(direction) {
            console.log(`Changing month by ${direction}`);
            alert(`Month navigation will be implemented in production`);
        }

        // Removed duplicate editCampaign function - using the one above that actually works

        function scheduleCampaign(platform, date) {
            // This will schedule the campaign for posting
            alert(`Schedule ${platform} campaign for ${date}\n\nThis will:\n Set the posting time\n Queue the campaign\n Enable automatic posting if accounts are connected`);
        }

        function showBacklinkRecommendationsOld() {
            const content = document.getElementById('recommendationsContent');
            let html = '';
            
            if (!currentAnalysis.backlinks) {
                html = '<div class="loading"> Backlink analysis not available in sandbox mode<br><small>This feature requires DataForSEO Labs subscription for production use</small></div>';
            } else {
                html += '<div class="recommendation-item">';
                html += '<div class="recommendation-title"> Backlink Strategy</div>';
                html += '<div class="recommendation-description">Improve your backlink profile:</div>';
                html += '<ul style="margin: 15px 0; padding-left: 20px;">';
                html += '<li>Focus on high-authority domains</li>';
                html += '<li>Create shareable content</li>';
                html += '<li>Build relationships with industry influencers</li>';
                html += '<li>Monitor competitor backlinks</li>';
                html += '</ul>';
                html += '<div class="recommendation-actions">';
                html += '<button class="action-btn implement" onclick="implementRecommendation(\'backlinks\')">Build Strategy</button>';
                html += '<button class="action-btn learn" onclick="learnMore(\'backlinks\')">Learn More</button>';
                html += '</div></div>';
            }
            
            content.innerHTML = html;
        }

        // Context-specific Mozarex AI functionality
        function askMozarexAI() {
            const modal = document.getElementById('mozarexModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContext = document.getElementById('modalContext');
            const aiMessages = document.getElementById('aiMessages');
            
            // Get current section context
            const activeCard = document.querySelector('.analysis-card.active');
            const sectionTitle = activeCard ? activeCard.querySelector('.card-title').textContent : 'Technical Analysis';
            
            // Set context
            if (sectionTitle.includes('Technical')) {
                currentContext = 'technical';
                modalTitle.textContent = ' Ask Mozarex AI - Technical Analysis';
                modalContext.innerHTML = `
                    <strong>Current Section:</strong> Technical Analysis<br>
                    <strong>Focus:</strong> Title tags, meta descriptions, image alt text, heading structure, content length<br>
                    <strong>Ask about:</strong> How to fix technical SEO issues, optimization strategies, implementation guides
                `;
            } else if (sectionTitle.includes('Keyword')) {
                currentContext = 'keywords';
                modalTitle.textContent = ' Ask Mozarex AI - Keyword Analysis';
                modalContext.innerHTML = `
                    <strong>Current Section:</strong> Keyword Analysis<br>
                    <strong>Focus:</strong> Keyword research, difficulty analysis, ranking strategies<br>
                    <strong>Ask about:</strong> Keyword optimization, content strategy, ranking improvements
                `;
            } else if (sectionTitle.includes('Competitor')) {
                currentContext = 'competitors';
                modalTitle.textContent = ' Ask Mozarex AI - Competitor Analysis';
                modalContext.innerHTML = `
                    <strong>Current Section:</strong> Competitor Analysis<br>
                    <strong>Focus:</strong> Competitor strategies, market positioning, competitive advantages<br>
                    <strong>Ask about:</strong> How to outperform competitors, market opportunities, strategic insights
                `;
            } else if (sectionTitle.includes('Backlink')) {
                currentContext = 'backlinks';
                modalTitle.textContent = ' Ask Mozarex AI - Backlink Analysis';
                modalContext.innerHTML = `
                    <strong>Current Section:</strong> Backlink Analysis<br>
                    <strong>Focus:</strong> Link building, domain authority, referral traffic<br>
                    <strong>Ask about:</strong> Link building strategies, authority improvement, outreach tactics
                `;
            }
            
            // Initialize chat history if empty
            if (chatHistory.length === 0) {
                chatHistory = [{
                    type: 'ai',
                    content: `Hi! I'm here to help you with ${sectionTitle.toLowerCase()}. 
                    I have access to your current analysis data and can provide specific recommendations. 
                    What would you like to know about ${sectionTitle.toLowerCase()}?`
                }];
            }
            
            // Display chat history
            displayChatHistory();
            
            // Show modal
            modal.style.display = 'block';
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('aiInput').focus();
            }, 100);
        }
        
        function closeMozarexModal() {
            document.getElementById('mozarexModal').style.display = 'none';
        }
        
        // Convert markdown to HTML for better formatting
        function formatMarkdownToHTML(text) {
            if (!text) return '';
            
            let html = text;
            
            // Convert **bold** to <strong>bold</strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert *italic* to <em>italic</em> (but not if it's part of **bold**)
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Split into paragraphs (double line breaks)
            const paragraphs = html.split(/\n\s*\n/);
            
            // Process each paragraph
            const processedParagraphs = paragraphs.map(paragraph => {
                if (!paragraph.trim()) return '';
                
                // Check if it's a numbered list item
                if (/^\d+\.\s*\*\*/.test(paragraph.trim())) {
                    // Convert numbered list
                    const listItems = paragraph.split(/\n(?=\d+\.)/).map(item => {
                        const match = item.match(/^(\d+)\.\s*\*\*(.*?)\*\*:\s*(.*)/);
                        if (match) {
                            return `<li><strong>${match[2]}:</strong> ${match[3]}</li>`;
                        }
                        return `<li>${item.replace(/^\d+\.\s*/, '')}</li>`;
                    });
                    return `<ul>${listItems.join('')}</ul>`;
                }
                
                // Check if it's a bullet list item
                if (/^-\s*\*\*/.test(paragraph.trim())) {
                    // Convert bullet list
                    const listItems = paragraph.split(/\n(?=-)/).map(item => {
                        const match = item.match(/^-\s*\*\*(.*?)\*\*:\s*(.*)/);
                        if (match) {
                            return `<li><strong>${match[1]}:</strong> ${match[2]}</li>`;
                        }
                        return `<li>${item.replace(/^-\s*/, '')}</li>`;
                    });
                    return `<ul>${listItems.join('')}</ul>`;
                }
                
                // Regular paragraph - convert single line breaks to <br>
                return `<p>${paragraph.replace(/\n/g, '<br>')}</p>`;
            });
            
            return processedParagraphs.filter(p => p).join('');
        }
        
        async function sendToMozarexAI() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            console.log('Input element:', input);
            console.log('Input value:', input ? input.value : 'input is null');
            console.log('Trimmed message:', message);
            console.log('Message length:', message.length);
            
            if (!message || message.length === 0) {
                console.log('Message is empty or whitespace, returning');
                addMessageToChat('Please enter a message before sending.', 'ai');
                return;
            }
            
            console.log('Message to send:', message);
            
            // Check if we have analysis data
            if (!currentAnalysis) {
                alert('Please analyze a website first before asking Mozarex AI');
                return;
            }
            
            const aiMessages = document.getElementById('aiMessages');
            
            // Add user message to chat history
            chatHistory.push({
                type: 'user',
                content: message
            });
            
            // Display updated chat history
            displayChatHistory();
            
            // Clear input
            input.value = '';
            
            // Disable send button
            const sendBtn = document.querySelector('#mozarexModal button[onclick="sendToMozarexAI()"]');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
            }
            
            // Add loading message to chat history
            chatHistory.push({
                type: 'ai',
                content: 'Thinking...',
                isTemporary: true
            });
            
            // Display updated chat history
            displayChatHistory();
            
            // Scroll to bottom
            aiMessages.scrollTop = aiMessages.scrollHeight;
            
            try {
                const requestData = {
                    message: message,
                    analysis: currentAnalysis,
                    domain: currentDomain,
                    context: currentContext
                };
                
                console.log('Sending to Mozarex AI:', requestData);
                console.log('Request URL:', '/api/ai/mozarex-chat');
                
                const response = await fetch('/api/ai/mozarex-chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Mozarex AI response:', result);
                    console.log('AI response text:', result.response);
                    console.log('Current aiMessages innerHTML:', aiMessages.innerHTML);
                    
                    if (result.success) {
                        // Replace the temporary loading message with the actual response
                        const lastMessageIndex = chatHistory.length - 1;
                        if (chatHistory[lastMessageIndex] && chatHistory[lastMessageIndex].isTemporary) {
                            chatHistory[lastMessageIndex] = {
                                type: 'ai',
                                content: result.response
                            };
                        } else {
                            chatHistory.push({
                                type: 'ai',
                                content: result.response
                            });
                        }
                        
                        // Display updated chat history
                        displayChatHistory();
                    } else {
                        throw new Error(result.error || 'AI response failed');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Mozarex AI API Error Response:', errorText);
                    console.error('Response status:', response.status);
                    console.error('Request data that failed:', requestData);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Mozarex AI error:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                
                // Replace the temporary loading message with error
                const lastMessageIndex = chatHistory.length - 1;
                if (chatHistory[lastMessageIndex] && chatHistory[lastMessageIndex].isTemporary) {
                    chatHistory[lastMessageIndex] = {
                        type: 'ai',
                        content: `Error: ${error.message}`
                    };
                } else {
                    chatHistory.push({
                        type: 'ai',
                        content: `Error: ${error.message}`
                    });
                }
                
                // Display updated chat history
                displayChatHistory();
            }
            
            // Scroll to bottom
            aiMessages.scrollTop = aiMessages.scrollHeight;
        }

        // New function to show AI proposals when Mozarex AI button is clicked
        async function showMozarexAIProposals() {
            const content = document.getElementById('recommendationsContent');
            
            // Show loading state
            content.innerHTML = '<div class="loading-state"> Mozarex AI is analyzing your data and generating intelligent proposals...</div>';
            
            try {
                // Get current domain and context
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const context = getCurrentContext();
                
                console.log('AI Proposals Debug:');
                console.log('- Domain:', domain);
                console.log('- Context:', context);
                console.log('- Current Analysis:', currentAnalysis);
                
                // Ensure we have analysis data
                if (!currentAnalysis) {
                    throw new Error('No analysis data available. Please analyze your website first.');
                }
                
                // Call AI proposal generation API
                const response = await fetch('/api/ai/generate-proposals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis: currentAnalysis,
                        domain: domain,
                        section: context.toLowerCase()
                    })
                });
                
                console.log('AI Proposals Response Status:', response.status);
                const result = await response.json();
                console.log('AI Proposals Result:', result);
                
                if (result.success && result.proposals) {
                    displayProposals(result.proposals, `${context} AI Proposals`);
                } else {
                    throw new Error(result.error || 'Failed to generate proposals');
                }
                
            } catch (error) {
                console.error('Error generating AI proposals:', error);
                content.innerHTML = '<div class="error-state"> Failed to generate AI proposals: ' + error.message + '</div>';
            }
        }
        
        // Allow Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendToMozarexAI();
                    }
                });
            }
        });

        function implementRecommendation(type) {
            alert('Implementation guide for ' + type + ' will be shown here');
        }

        function learnMore(type) {
            alert('Learning resources for ' + type + ' will be shown here');
        }

        async function generateContentCalendar() {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = '<div class="loading-state"> Mozarex AI is generating service-based content...</div>';
            
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user'; // In production, get from auth
                
                console.log(' Generating intelligent content for:', domain);
                
                // Call the new intelligent content generation API
                const response = await fetch('/api/content/generate-service-based', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userId,
                        domain: domain,
                        days: 7
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(' Intelligent content generated:', result.data);
                    
                    // Convert to campaign format and display
                    const campaignData = convertSupabaseContentToCampaigns(result.data);
                    displayCampaignCalendar(campaignData);
                    
                    // Update calendar metrics
                    updateCalendarMetrics(result.data);
                    
                    // Show approval queue if there are draft items
                    const draftCount = result.data.filter(item => item.status === 'draft').length;
                    if (draftCount > 0) {
                        showApprovalNotification(draftCount);
                    }
                    
                } else {
                    throw new Error(result.error || 'Failed to generate content');
                }
                
            } catch (error) {
                console.error(' Error generating intelligent content:', error);
                content.innerHTML = `
                    <div class="error-state">
                        <h3> Content Generation Failed</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="generateContentCalendar()"> Try Again</button>
                    </div>
                `;
            }
        }

        function convertSupabaseContentToCampaigns(supabaseContent) {
            const campaigns = {};
            
            supabaseContent.forEach(entry => {
                const date = entry.target_date;
                if (!campaigns[date]) {
                    campaigns[date] = {};
                }
                
                campaigns[date][entry.platform] = {
                    content: entry.content,
                    tip: entry.engagement_tip || 'Engage with your audience',
                    time: entry.scheduled_time || '10:00 AM',
                    status: entry.status,
                    contentId: entry.id,
                    approvedBy: entry.approved_by,
                    approvedAt: entry.approved_at
                };
            });
            
            return campaigns;
        }

        function showApprovalNotification(draftCount) {
            const notification = document.createElement('div');
            notification.className = 'approval-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon"></div>
                    <div class="notification-text">
                        <strong>${draftCount} content items</strong> need your approval before posting
                    </div>
                    <button class="btn btn-primary" onclick="showApprovalQueue()">Review & Approve</button>
                    <button class="btn btn-secondary" onclick="closeApprovalNotification()">Later</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        function closeApprovalNotification() {
            const notification = document.querySelector('.approval-notification');
            if (notification) {
                notification.remove();
            }
        }

        async function showApprovalQueue() {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = '<div class="loading-state"> Loading approval queue...</div>';
            
            try {
                const domain = localStorage.getItem('lastAnalyzedDomain') || 'mozarex.com';
                const userId = 'mozarex-user';
                
                const response = await fetch(`/api/content/approval-queue/${userId}/${domain}`);
                const result = await response.json();
                
                if (result.success) {
                    displayApprovalQueue(result.data);
                } else {
                    throw new Error(result.error || 'Failed to load approval queue');
                }
                
            } catch (error) {
                console.error(' Error loading approval queue:', error);
                content.innerHTML = `
                    <div class="error-state">
                        <h3> Failed to Load Approval Queue</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="showApprovalQueue()"> Try Again</button>
                    </div>
                `;
            }
        }

        function displayApprovalQueue(approvalQueue) {
            const content = document.getElementById('recommendationsContent');
            
            if (approvalQueue.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"></div>
                        <h3>All Content Approved!</h3>
                        <p>No pending content items to review.</p>
                        <button class="btn btn-primary" onclick="showContentCalendar()">Back to Calendar</button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="approval-queue-header">
                    <button class="btn-back" onclick="showContentCalendar()"> Back to Calendar</button>
                    <h3> Content Approval Queue</h3>
                    <div class="approval-stats">
                        <span class="stat-badge pending">${approvalQueue.length} Pending</span>
                    </div>
                </div>
                <div class="approval-queue-list">
            `;
            
            // Group by date
            const groupedByDate = {};
            approvalQueue.forEach(item => {
                if (!groupedByDate[item.target_date]) {
                    groupedByDate[item.target_date] = [];
                }
                groupedByDate[item.target_date].push(item);
            });
            
            Object.keys(groupedByDate).sort().forEach(date => {
                const dateItems = groupedByDate[date];
                const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                html += `
                    <div class="approval-date-group">
                        <h4 class="date-header"> ${formattedDate}</h4>
                        <div class="approval-items">
                `;
                
                dateItems.forEach(item => {
                    html += `
                        <div class="approval-item" data-content-id="${item.id}">
                            <div class="approval-platform">
                                <span class="platform-icon">${getPlatformIcon(item.platform)}</span>
                                <span class="platform-name">${item.platform.charAt(0).toUpperCase() + item.platform.slice(1)}</span>
                                <span class="scheduled-time">${item.scheduled_time || '10:00 AM'}</span>
                            </div>
                            <div class="approval-content">
                                <p class="content-text">${item.content}</p>
                                ${item.engagement_tip ? `<div class="content-tip"><strong> Tip:</strong> ${item.engagement_tip}</div>` : ''}
                            </div>
                            <div class="approval-actions">
                                <button class="btn btn-success" onclick="approveContent('${item.id}')"> Approve</button>
                                <button class="btn btn-danger" onclick="rejectContent('${item.id}')"> Reject</button>
                                <button class="btn btn-outline" onclick="editContent('${item.id}')"> Edit</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                <div class="approval-queue-actions">
                    <button class="btn btn-primary" onclick="approveAllContent()"> Approve All</button>
                    <button class="btn btn-secondary" onclick="showContentCalendar()">Back to Calendar</button>
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function approveContent(contentId) {
            try {
                const response = await fetch(`/api/content/approve/${contentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approvedBy: 'customer'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Remove from approval queue
                    const approvalItem = document.querySelector(`[data-content-id="${contentId}"]`);
                    if (approvalItem) {
                        approvalItem.remove();
                    }
                    
                    // Show success message
                    showToast(' Content approved successfully!', 'success');
                    
                    // Update calendar metrics
                    refreshCalendarMetrics();
                    
                    // Check if queue is empty
                    const remainingItems = document.querySelectorAll('.approval-item');
                    if (remainingItems.length === 0) {
                        showApprovalQueue(); // Refresh to show empty state
                    }
                } else {
                    throw new Error(result.error || 'Failed to approve content');
                }
                
            } catch (error) {
                console.error(' Error approving content:', error);
                showToast(' Failed to approve content: ' + error.message, 'error');
            }
        }

        async function rejectContent(contentId) {
            const reason = prompt('Why are you rejecting this content? (optional):');
            
            try {
                const response = await fetch(`/api/content/reject/${contentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: reason || 'Not suitable'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Remove from approval queue
                    const approvalItem = document.querySelector(`[data-content-id="${contentId}"]`);
                    if (approvalItem) {
                        approvalItem.remove();
                    }
                    
                    // Show success message
                    showToast(' Content rejected', 'info');
                    
                    // Check if queue is empty
                    const remainingItems = document.querySelectorAll('.approval-item');
                    if (remainingItems.length === 0) {
                        showApprovalQueue(); // Refresh to show empty state
                    }
                } else {
                    throw new Error(result.error || 'Failed to reject content');
                }
                
            } catch (error) {
                console.error(' Error rejecting content:', error);
                showToast(' Failed to reject content: ' + error.message, 'error');
            }
        }

        function editContent(contentId) {
            // Find the content item
            const approvalItem = document.querySelector(`[data-content-id="${contentId}"]`);
            if (!approvalItem) return;
            
            const contentText = approvalItem.querySelector('.content-text').textContent;
            const tipText = approvalItem.querySelector('.content-tip')?.textContent?.replace(' Tip: ', '') || '';
            const platform = approvalItem.querySelector('.platform-name').textContent.toLowerCase();
            const time = approvalItem.querySelector('.scheduled-time').textContent;
            
            // Use existing campaign editor modal
            showCampaignEditor({
                dateString: 'edit-mode',
                platform: platform,
                content: contentText,
                tip: tipText,
                time: time,
                contentId: contentId
            });
        }

        async function approveAllContent() {
            if (!confirm('Approve all pending content items? This action cannot be undone.')) {
                return;
            }
            
            const approvalItems = document.querySelectorAll('.approval-item');
            let approvedCount = 0;
            
            for (const item of approvalItems) {
                const contentId = item.getAttribute('data-content-id');
                try {
                    await approveContent(contentId);
                    approvedCount++;
                } catch (error) {
                    console.error(`Failed to approve content ${contentId}:`, error);
                }
            }
            
            showToast(` Approved ${approvedCount} content items!`, 'success');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function convertCalendarToCampaignFormat(calendar) {
            // Convert AI-generated calendar to campaign format
            const campaigns = {};
            
            calendar.forEach(day => {
                const date = new Date();
                date.setDate(date.getDate() + (day.day - 1));
                const dateString = date.toISOString().split('T')[0];
                
                campaigns[dateString] = {};
                
                Object.entries(day.platforms).forEach(([platform, data]) => {
                    campaigns[dateString][platform] = {
                        content: data.content,
                        time: data.time,
                        tip: data.tip
                    };
                });
            });
            
            return campaigns;
        }

        function generateMockCampaignCalendar() {
            // Generate mock campaign data for testing
            const campaigns = {};
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                
                campaigns[dateString] = {
                    twitter: {
                        content: `Day ${i + 1}: SEO tip - Optimize your meta descriptions for better click-through rates! #SEO #Mozarex`,
                        time: "10:00 AM",
                        tip: "Use relevant hashtags to increase reach"
                    },
                    facebook: {
                        content: `Day ${i + 1}: Learn about website optimization strategies with Mozarex! #DigitalMarketing`,
                        time: "2:00 PM",
                        tip: "Ask questions to encourage engagement"
                    },
                    instagram: {
                        content: `Day ${i + 1}: Visual SEO tip - Optimize your image alt text! #SEO #Mozarex`,
                        time: "7:00 PM",
                        tip: "Use carousel posts for better engagement"
                    },
                    tiktok: {
                        content: `Day ${i + 1}: Quick SEO hack - Use long-tail keywords! #SEOTips #Mozarex`,
                        time: "6:00 PM",
                        tip: "Keep videos under 60 seconds"
                    }
                };
            }
            
            return campaigns;
        }

        function displayCalendar(calendar) {
            const content = document.getElementById('calendarContent');
            let html = '<div class="calendar-grid">';
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            // Add month title
            html += '<div style="grid-column: 1 / -1; text-align: center; font-size: 1.2rem; font-weight: 600; margin-bottom: 15px;">';
            html += monthNames[currentMonth] + ' ' + currentYear;
            html += '</div>';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += '<div style="text-align: center; font-weight: 600; padding: 10px; background: #e9ecef;">' + day + '</div>';
            });
            
            // Add calendar days
            for (let i = 1; i <= 30; i++) {
                const hasContent = Math.random() > 0.3; // 70% chance of having content
                html += '<div class="calendar-day' + (hasContent ? ' has-content' : '') + '" onclick="showDayContent(' + i + ')">';
                html += '<div class="day-number">' + i + '</div>';
                if (hasContent) {
                    html += '<div class="day-content"> Content</div>';
                }
                html += '</div>';
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function generateMockCalendar() {
            return {
                days: Array.from({length: 30}, (_, i) => ({
                    day: i + 1,
                    hasContent: Math.random() > 0.3,
                    platforms: ['twitter', 'facebook', 'tiktok', 'instagram']
                }))
            };
        }

        function showDayContent(day) {
            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = `Content Recommendations - Day ${day}`;
            
            let html = '<div class="social-platforms">';
            
            // Twitter
            html += '<div class="platform-card">';
            html += '<div class="platform-title"> Twitter</div>';
            html += '<div class="platform-content">';
            html += '<strong>Post:</strong> "Check out our latest insights on ' + (currentAnalysis?.onPage?.title || 'SEO optimization') + '! #SEO #DigitalMarketing"<br>';
            html += '<strong>Best time:</strong> 9:00 AM - 12:00 PM<br>';
            html += '<strong>Engagement tip:</strong> Use trending hashtags and ask questions';
            html += '</div></div>';
            
            // Facebook
            html += '<div class="platform-card">';
            html += '<div class="platform-title"> Facebook</div>';
            html += '<div class="platform-content">';
            html += '<strong>Post:</strong> "Did you know that proper SEO can increase your website traffic by up to 300%? Learn more about optimizing your ' + (currentAnalysis?.onPage?.title || 'website') + ' for better visibility."<br>';
            html += '<strong>Best time:</strong> 1:00 PM - 3:00 PM<br>';
            html += '<strong>Engagement tip:</strong> Share valuable tips and encourage discussion';
            html += '</div></div>';
            
            // TikTok
            html += '<div class="platform-card">';
            html += '<div class="platform-title"> TikTok</div>';
            html += '<div class="platform-content">';
            html += '<strong>Video:</strong> "Quick SEO tip: Use descriptive alt text for your images!  #SEOTips #DigitalMarketing"<br>';
            html += '<strong>Best time:</strong> 6:00 PM - 9:00 PM<br>';
            html += '<strong>Engagement tip:</strong> Keep it short, fun, and educational';
            html += '</div></div>';
            
            // Instagram
            html += '<div class="platform-card">';
            html += '<div class="platform-title"> Instagram</div>';
            html += '<div class="platform-content">';
            html += '<strong>Post:</strong> "Behind the scenes: How we optimize websites for better search rankings  #SEO #WebDesign #DigitalMarketing"<br>';
            html += '<strong>Best time:</strong> 11:00 AM - 1:00 PM<br>';
            html += '<strong>Engagement tip:</strong> Use high-quality visuals and relevant hashtags';
            html += '</div></div>';
            
            html += '</div>';
            
            modalContent.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('contentModal').style.display = 'none';
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateContentCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateContentCalendar();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('contentModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Keyword Management Functions
        function optimizeKeyword(keywordIndex) {
            const keyword = currentAnalysis.keywords.keywords[keywordIndex];
            const optimizationModal = document.createElement('div');
            optimizationModal.className = 'modal';
            optimizationModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Optimize Keyword: ${keyword.keyword}</h3>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="optimization-form">
                            <div class="form-group">
                                <label>Content Optimization Suggestions:</label>
                                <textarea id="optimizationContent" rows="4" placeholder="Enter content optimization suggestions for this keyword..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Target Pages:</label>
                                <input type="text" id="targetPages" placeholder="e.g., /services, /about, homepage" />
                            </div>
                            <div class="form-actions">
                                <button onclick="saveOptimization(${keywordIndex})" class="save-btn">Save Optimization</button>
                                <button onclick="addToCalendar(${keywordIndex})" class="calendar-btn">Add to Content Calendar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(optimizationModal);
        }

        function addToCalendar(keywordIndex) {
            const keyword = currentAnalysis.keywords.keywords[keywordIndex];
            const calendarModal = document.createElement('div');
            calendarModal.className = 'modal';
            calendarModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Add to Content Calendar: ${keyword.keyword}</h3>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="calendar-form">
                            <div class="form-group">
                                <label>Content Type:</label>
                                <select id="contentType">
                                    <option value="blog">Blog Post</option>
                                    <option value="social">Social Media</option>
                                    <option value="page">Page Content</option>
                                    <option value="landing">Landing Page</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Target Date:</label>
                                <input type="date" id="targetDate" />
                            </div>
                            <div class="form-group">
                                <label>Content Ideas:</label>
                                <textarea id="contentIdeas" rows="3" placeholder="Enter content ideas for this keyword..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button onclick="saveToCalendar(${keywordIndex})" class="save-btn">Add to Calendar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(calendarModal);
        }

        function addKeywordSuggestion(keyword) {
            // Add keyword to the analysis
            if (!currentAnalysis.keywords.keywords.find(k => k.keyword === keyword)) {
                currentAnalysis.keywords.keywords.push({
                    keyword: keyword,
                    searchVolume: 'N/A',
                    difficulty: 'N/A',
                    currentRank: 'Not ranked'
                });
                
                // Refresh the keyword display
                showKeywordRecommendations();
                
                // Show success message
                showNotification(`Keyword "${keyword}" added successfully!`, 'success');
            } else {
                showNotification(`Keyword "${keyword}" already exists!`, 'warning');
            }
        }

        function showAddKeywordModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3> Add Primary Keyword</h3>
                        <span class="close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="add-keyword-form">
                            <div class="form-group">
                                <label>Keyword:</label>
                                <input type="text" id="newKeyword" placeholder="Enter your primary keyword..." />
                            </div>
                            <div class="form-group">
                                <label>Search Volume (optional):</label>
                                <input type="number" id="searchVolume" placeholder="Monthly search volume" />
                            </div>
                            <div class="form-group">
                                <label>Difficulty (1-100):</label>
                                <input type="number" id="difficulty" min="1" max="100" placeholder="Keyword difficulty" />
                            </div>
                            <div class="form-actions">
                                <button onclick="addNewKeyword()" class="save-btn">Add Keyword</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function addNewKeyword() {
            const keyword = document.getElementById('newKeyword').value.trim();
            const searchVolume = document.getElementById('searchVolume').value;
            const difficulty = document.getElementById('difficulty').value;
            
            if (!keyword) {
                showNotification('Please enter a keyword!', 'error');
                return;
            }
            
            if (!currentAnalysis.keywords.keywords.find(k => k.keyword === keyword)) {
                currentAnalysis.keywords.keywords.push({
                    keyword: keyword,
                    searchVolume: searchVolume || 'N/A',
                    difficulty: difficulty || 'N/A',
                    currentRank: 'Not ranked'
                });
                
                // Refresh the keyword display
                showKeywordRecommendations();
                
                // Close modal
                document.querySelector('.modal').remove();
                
                showNotification(`Keyword "${keyword}" added successfully!`, 'success');
            } else {
                showNotification(`Keyword "${keyword}" already exists!`, 'warning');
            }
        }

        function saveOptimization(keywordIndex) {
            const content = document.getElementById('optimizationContent').value;
            const pages = document.getElementById('targetPages').value;
            
            if (!content) {
                showNotification('Please enter optimization suggestions!', 'error');
                return;
            }
            
            // Save optimization (in real app, this would save to database)
            showNotification('Optimization saved successfully!', 'success');
            document.querySelector('.modal').remove();
        }

        function saveToCalendar(keywordIndex) {
            const keyword = currentAnalysis.keywords.keywords[keywordIndex];
            const contentType = document.getElementById('contentType').value;
            const targetDate = document.getElementById('targetDate').value;
            const contentIdeas = document.getElementById('contentIdeas').value;
            
            if (!targetDate) {
                showNotification('Please select a target date!', 'error');
                return;
            }
            
            // Save to calendar (in real app, this would save to database)
            showNotification(`Content for "${keyword.keyword}" added to calendar!`, 'success');
            document.querySelector('.modal').remove();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') notification.style.background = '#10b981';
            else if (type === 'error') notification.style.background = '#ef4444';
            else if (type === 'warning') notification.style.background = '#f59e0b';
            else notification.style.background = '#3b82f6';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Interactive Chat Functions
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            input.value = '';
            
            // Disable send button while processing
            const sendBtn = document.getElementById('sendChatBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Thinking...';
            
            // Send to Mozarex AI
            sendToMozarexAI(message);
        }

        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (sender === 'user') {
                contentDiv.textContent = message;
            } else {
                contentDiv.innerHTML = `<strong>Mozarex AI:</strong> ${message}`;
            }
            
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }


        // Initialize calendar on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (currentAnalysis) {
                generateContentCalendar();
            }
        });
        
        // Error handler for debugging
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            console.error('Error details:', e.message, 'at line', e.lineno);
        });
    </script>
</body>
</html>
