<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K59VFCP8');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Onboarding - Mozarex SEO</title>
    <link rel="stylesheet" href="/frontend/styles.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .onboarding-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            text-align: center;
            position: relative;
        }
        .logo {
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
            color: #007bff;
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e0e0e0;
            transform: translateY(-50%);
            z-index: 0;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .step-circle {
            width: 36px;
            height: 36px;
            background-color: #e0e0e0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 10px auto;
            font-weight: 600;
            color: #888;
            transition: background-color 0.3s, color 0.3s;
        }
        .step-label {
            font-size: 14px;
            color: #666;
        }
        .step.active .step-circle {
            background-color: #007bff;
            color: #fff;
        }
        .step.completed .step-circle {
            background-color: #28a745;
            color: #fff;
        }
        .step-content {
            text-align: left;
        }
        .step-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }
        .step-description {
            font-size: 16px;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .input-group {
            margin-bottom: 25px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        .input-group input[type="text"],
        .input-group textarea {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .input-group input[type="text"]:focus,
        .input-group textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        .business-input {
            min-height: 120px;
            resize: vertical;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 15px;
            display: none;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .debug-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        .debug-log h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .debug-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .debug-entry.success {
            color: #28a745;
        }
        .debug-entry.error {
            color: #dc3545;
        }
        .debug-entry.info {
            color: #007bff;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K59VFCP8"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <div class="onboarding-container">
        <div class="logo">üîç Debug Onboarding - Mozarex SEO</div>
        
        <div class="progress-bar">
            <div class="step active" id="step1">
                <div class="step-circle">1</div>
                <div class="step-label">Website</div>
            </div>
            <div class="step" id="step2">
                <div class="step-circle">2</div>
                <div class="step-label">Business Info</div>
            </div>
        </div>
        
        <div id="error-message" class="message error-message"></div>
        <div id="success-message" class="message success-message"></div>

        <!-- Step 1: Website Input -->
        <div class="step-content" id="step1-content">
            <h1 class="step-title">Enter Your Website</h1>
            <p class="step-description">
                Let's start by analyzing your website to provide tailored SEO recommendations.
                Please enter your full domain name (e.g., example.com).
            </p>
            <div class="input-group">
                <input type="text" id="domain-input" placeholder="e.g., example.com">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" id="analyze-btn" onclick="analyzeWebsite()">Analyze Website</button>
            </div>
        </div>

        <!-- Step 2: Business Description -->
        <div class="step-content" id="step2-content" style="display: none;">
            <h1 class="step-title">Describe Your Business</h1>
            <p class="step-description">
                Help us understand your business better so we can provide more targeted SEO recommendations and insights. This is the final step before accessing your dashboard.
            </p>
            <div class="input-group">
                <textarea class="business-input" id="business-input" placeholder="Tell us about your business, your target audience, and your main services or products..."></textarea>
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                <button class="btn btn-primary" onclick="event.preventDefault(); event.stopPropagation(); saveBusinessInfo(); return false;">Complete Setup</button>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="debug-log">
            <h4>üîç Debug Log</h4>
            <div id="debug-entries"></div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let isCompletingOnboarding = false;
        let userData = {
            domain: '',
            businessDescription: '',
            integrations: {
                console: false,
                business: false
            },
            analysisData: null
        };

        function addDebugLog(message, type = 'info') {
            const debugEntries = document.getElementById('debug-entries');
            const entry = document.createElement('div');
            entry.className = `debug-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugEntries.appendChild(entry);
            debugEntries.scrollTop = debugEntries.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function goToStep(step) {
            addDebugLog(`goToStep called: ${currentStep} ‚Üí ${step}`, 'info');
            addDebugLog(`isCompletingOnboarding: ${isCompletingOnboarding}`, 'info');
            
            // AGGRESSIVE BLOCKING: Prevent going back to step 1 if we're on step 2
            if (step === 1 && currentStep === 2) {
                addDebugLog('BLOCKED: Preventing step 2 to step 1 reset', 'error');
                return;
            }
            
            // Prevent going back to step 1 if we're completing onboarding
            if (step === 1 && isCompletingOnboarding) {
                addDebugLog('BLOCKED: Preventing step reset during onboarding completion', 'error');
                return;
            }
            
            addDebugLog(`Proceeding with goToStep to step ${step}`, 'success');
            
            // Hide all step contents
            document.querySelectorAll('.step-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all steps
            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
            });
            
            // Show target step content
            const targetContent = document.getElementById(`step${step}-content`);
            if (targetContent) {
                targetContent.style.display = 'block';
                addDebugLog(`Step ${step} content displayed`, 'success');
            } else {
                addDebugLog(`Step ${step} content not found!`, 'error');
                return;
            }
            
            // Add active class to target step
            const targetStep = document.getElementById(`step${step}`);
            if (targetStep) {
                targetStep.classList.add('active');
            }
            
            // Mark previous steps as completed
            for (let i = 1; i < step; i++) {
                const prevStep = document.getElementById(`step${i}`);
                if (prevStep) {
                    prevStep.classList.add('completed');
                }
            }
            
            currentStep = step;
            addDebugLog(`Successfully moved to step ${step}`, 'success');
        }

        async function analyzeWebsite() {
            const domainInput = document.getElementById('domain-input');
            const domain = domainInput.value.trim();
            
            addDebugLog(`analyzeWebsite called with domain: "${domain}"`, 'info');
            
            if (!domain) {
                addDebugLog('Error: No domain entered', 'error');
                showError('Please enter a domain');
                return;
            }
            
            if (!isValidDomain(domain)) {
                addDebugLog('Error: Invalid domain format', 'error');
                showError('Please enter a valid domain (e.g., example.com)');
                return;
            }
            
            userData.domain = domain;
            addDebugLog(`Domain set in userData: ${userData.domain}`, 'success');
            
            document.getElementById('analyze-btn').disabled = true;
            showSuccess('Analyzing website...');
            addDebugLog('Starting website analysis...', 'info');

            try {
                // Simulate analysis for now, actual API call will be here
                addDebugLog('Simulating analysis (skipping actual API call for debug)', 'info');
                
                // For demo purposes, directly go to next step
                setTimeout(() => {
                    addDebugLog('Analysis simulation complete, moving to step 2', 'success');
                    showSuccess('Website analyzed successfully! Please describe your business.');
                    goToStep(2);
                }, 1500);

            } catch (error) {
                addDebugLog(`Analysis error: ${error.message}`, 'error');
                console.error('Analysis error:', error);
                showError('Network error. Please check your connection and try again.');
            } finally {
                document.getElementById('analyze-btn').disabled = false;
            }
        }

        async function saveBusinessInfo() {
            addDebugLog('=== saveBusinessInfo START ===', 'info');
            addDebugLog(`Current step: ${currentStep}`, 'info');
            addDebugLog(`isCompletingOnboarding: ${isCompletingOnboarding}`, 'info');
            
            const businessInput = document.getElementById('business-input');
            const businessDescription = businessInput.value.trim();
            
            addDebugLog(`Business description length: ${businessDescription.length}`, 'info');
            
            if (!businessDescription) {
                addDebugLog('Error: No business description entered', 'error');
                showError('Please describe your business');
                return;
            }
            
            userData.businessDescription = businessDescription;
            addDebugLog(`Business description set: "${businessDescription.substring(0, 50)}..."`, 'success');
            addDebugLog(`Complete userData: ${JSON.stringify(userData)}`, 'info');
            
            // Set flag to prevent step reset
            isCompletingOnboarding = true;
            addDebugLog('Set isCompletingOnboarding to true', 'success');
            
            // Disable the Back button to prevent accidental clicks
            const backBtn = document.querySelector('#step2-content .btn-secondary');
            if (backBtn) {
                backBtn.disabled = true;
                backBtn.style.opacity = '0.5';
                addDebugLog('Disabled Back button during onboarding completion', 'success');
            }
            
            // Show loading state
            const completeBtn = document.querySelector('#step2-content .btn-primary');
            const originalText = completeBtn.textContent;
            completeBtn.textContent = 'Completing Setup...';
            completeBtn.disabled = true;
            addDebugLog('Set loading state on Complete button', 'success');
            
            try {
                addDebugLog('Starting completeOnboarding...', 'info');
                await completeOnboarding();
                addDebugLog('Onboarding completed successfully', 'success');
            } catch (error) {
                addDebugLog(`Error completing onboarding: ${error.message}`, 'error');
                console.error('Error completing onboarding:', error);
                showError('Failed to complete setup. Please try again.');
                completeBtn.textContent = originalText;
                completeBtn.disabled = false;
                
                // Don't reset to step 1 on error - stay on current step
                addDebugLog('Error occurred, staying on current step', 'info');
            }
        }

        async function completeOnboarding() {
            try {
                addDebugLog('=== completeOnboarding START ===', 'info');
                addDebugLog(`User data: ${JSON.stringify(userData)}`, 'info');
                
                // Show analysis progress
                showSuccess('Analyzing your website... This may take a moment.');
                addDebugLog('Showing analysis progress message', 'info');
                
                // First, analyze the website and store in Supabase
                if (userData.domain) {
                    addDebugLog(`Starting website analysis for: ${userData.domain}`, 'info');
                    
                    const analysisResponse = await fetch('/api/dataforseo/environment/analyze-website', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ url: userData.domain })
                    });
                    
                    addDebugLog(`Analysis response status: ${analysisResponse.status}`, 'info');
                    const analysisResult = await analysisResponse.json();
                    addDebugLog(`Analysis response success: ${analysisResult.success}`, analysisResult.success ? 'success' : 'error');
                    addDebugLog(`Analysis response keys: ${Object.keys(analysisResult)}`, 'info');
                    
                    if (analysisResult.success) {
                        addDebugLog('Website analysis completed successfully', 'success');
                        userData.analysisData = analysisResult.analysis;
                        addDebugLog(`Analysis data set: ${!!userData.analysisData}`, 'success');
                        
                        // Update success message
                        showSuccess('Analysis complete! Saving your data...');
                        addDebugLog('Updated success message', 'info');
                    } else {
                        addDebugLog(`Analysis failed: ${analysisResult.error}`, 'error');
                        showSuccess('Analysis encountered issues, but continuing with setup...');
                    }
                }
                
                addDebugLog('About to save user data to API...', 'info');
                // Save user data to database
                const response = await fetch('/api/user/save-onboarding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                addDebugLog(`Save response status: ${response.status}`, 'info');
                const result = await response.json();
                addDebugLog(`Save response: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    addDebugLog('Data saved successfully, preparing redirect...', 'success');
                    
                    // Store domain in localStorage for dashboard to find
                    localStorage.setItem('lastAnalyzedDomain', userData.domain);
                    addDebugLog(`Stored domain in localStorage: ${userData.domain}`, 'success');
                    
                    // Verify localStorage was set
                    const storedDomain = localStorage.getItem('lastAnalyzedDomain');
                    addDebugLog(`Verified localStorage: ${storedDomain}`, storedDomain === userData.domain ? 'success' : 'error');
                    
                    // Show final success message
                    showSuccess('Setup completed successfully! Redirecting to dashboard...');
                    addDebugLog('Showing final success message', 'info');
                    
                    // Redirect to dashboard after a short delay
                    setTimeout(() => {
                        addDebugLog('=== REDIRECT ATTEMPT ===', 'info');
                        addDebugLog(`Current URL: ${window.location.href}`, 'info');
                        addDebugLog('Redirecting to: /debug-dashboard', 'info');
                        
                        // Try multiple redirect methods
                        try {
                            window.location.href = '/debug-dashboard';
                            addDebugLog('Redirect method 1 executed', 'success');
                        } catch (e) {
                            addDebugLog(`Redirect method 1 failed: ${e.message}`, 'error');
                            try {
                                window.location.replace('/debug-dashboard');
                                addDebugLog('Redirect method 2 executed', 'success');
                            } catch (e2) {
                                addDebugLog(`Redirect method 2 failed: ${e2.message}`, 'error');
                                // Last resort - create a link and click it
                                const link = document.createElement('a');
                                link.href = '/debug-dashboard';
                                link.click();
                                addDebugLog('Redirect method 3 executed', 'success');
                            }
                        }
                    }, 1500);
                } else {
                    addDebugLog(`Save failed: ${result.error}`, 'error');
                    throw new Error(result.error || 'Failed to save data');
                }
            } catch (error) {
                addDebugLog(`Complete onboarding error: ${error.message}`, 'error');
                throw error; // Re-throw to be caught by calling function
            }
        }

        function isValidDomain(domain) {
            // Clean the domain input first
            const cleanDomain = normalizeDomainInput(domain);
            
            // Enhanced domain validation to support all TLDs including .com.au, .co.uk, etc.
            const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*\.[a-zA-Z]{2,}$/;
            return domainRegex.test(cleanDomain);
        }

        function normalizeDomainInput(domain) {
            let cleanDomain = domain.toLowerCase().trim();
            // Remove http/https and www.
            cleanDomain = cleanDomain.replace(/^(https?:\/\/)?(www\.)?/, '');
            // Remove trailing slash
            cleanDomain = cleanDomain.replace(/\/$/, '');
            return cleanDomain;
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            addDebugLog(`Error shown: ${message}`, 'error');
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.style.display = 'block';
            addDebugLog(`Success shown: ${message}`, 'success');
            
            // Don't auto-hide success messages during redirects
        }

        // Initial step display
        addDebugLog('Page loaded, initializing step 1', 'info');
        goToStep(1);
    </script>
</body>
</html>